<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏±‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå + Firebase</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Sarabun',sans-serif;background:linear-gradient(135deg,#e8f5e9,#c8e6c9);min-height:100vh;padding:8px;padding-bottom:70px}
    .container{max-width:650px;margin:0 auto}
    h1{text-align:center;color:#2e7d32;font-size:1.3em;margin-bottom:2px}
    .subtitle{text-align:center;color:#43a047;font-size:0.7em;margin-bottom:10px}
    .card{background:#fff;border-radius:16px;padding:14px;margin-bottom:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .card h2{color:#2e7d32;font-size:1em;margin-bottom:10px}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .form-group{margin-bottom:10px}
    .form-group label{display:block;font-size:0.75em;color:#555;margin-bottom:4px;font-weight:600}
    select,input[type="date"],input[type="number"],input[type="text"]{width:100%;padding:10px;border:2px solid #c8e6c9;border-radius:10px;font-size:14px;outline:none}
    input:focus,select:focus{border-color:#4caf50}
    input.error{border-color:#ef5350;background:#ffebee}
    .error-msg{color:#c62828;font-size:0.7em;margin-top:2px}
    .btn{background:linear-gradient(135deg,#66bb6a,#43a047);color:#fff;border:none;padding:12px;border-radius:12px;font-size:0.85em;font-weight:700;cursor:pointer;width:100%}
    .btn:hover{opacity:0.9}
    .btn-sm{padding:8px 12px;font-size:0.75em;width:auto}
    .btn-danger{background:linear-gradient(135deg,#ef5350,#c62828)}
    .btn-blue{background:linear-gradient(135deg,#42a5f5,#1976d2)}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none!important}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:8px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:100}
    .nav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border:none;background:0 0;cursor:pointer;color:#888;font-size:0.65em;border-radius:12px}
    .nav-btn .icon{font-size:1.4em}
    .nav-btn.active{color:#4caf50;background:#e8f5e9}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .status-card{background:linear-gradient(135deg,#ffd54f,#ff9800);border-radius:16px;padding:14px;color:#fff;margin-bottom:10px}
    .status-card h2{color:#fff;margin-bottom:4px;font-size:0.95em}
    .status-card p{font-size:0.8em;opacity:0.9}
    .status-badges{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .status-badge{background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:0.7em}
    .phase-card{border-left:4px solid #4caf50}
    .phase-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .phase-title{font-weight:700;color:#2e7d32;font-size:0.95em}
    .phase-badge{background:#4caf50;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.65em}
    .phase-desc{color:#666;font-size:0.8em;margin-bottom:10px}
    .bio-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
    .bio-tag{padding:4px 10px;border-radius:12px;font-size:0.7em;border:1px solid}
    .bio-em{background:#fff3e0;color:#e65100;border-color:#ffcc80}
    .bio-tricho{background:#e8f5e9;color:#2e7d32;border-color:#a5d6a7}
    .bio-beau{background:#fce4ec;color:#c2185b;border-color:#f8bbd9}
    .bio-meta{background:#e3f2fd;color:#1565c0;border-color:#90caf9}
    .bio-hormone{background:#f3e5f5;color:#7b1fa2;border-color:#ce93d8}
    .checklist{list-style:none}
    .checklist li{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;margin-bottom:4px;background:#f5f5f5;border-radius:10px;cursor:pointer;font-size:0.8em}
    .checklist li.done{background:#c8e6c9}
    .checklist li.done span{text-decoration:line-through;color:#888}
    .checklist input[type="checkbox"]{width:20px;height:20px;accent-color:#4caf50}
    .progress-wrap{background:#e0e0e0;border-radius:10px;height:8px;margin-top:8px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,#81c784,#4caf50)}
    .progress-text{display:flex;justify-content:space-between;font-size:0.7em;color:#666;margin-top:4px}
    .quick-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .quick-btn{padding:12px 6px;border:none;border-radius:12px;cursor:pointer;background:#f0f0f0;display:flex;flex-direction:column;align-items:center;gap:4px}
    .quick-btn.done{background:#4caf50;color:#fff}
    .quick-btn .icon{font-size:1.3em}
    .quick-btn .label{font-size:0.65em;font-weight:600}
    .quick-btn .time{font-size:0.55em;opacity:0.8}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;text-align:center}
    .stat-box{background:#f5f5f5;padding:10px 6px;border-radius:12px}
    .stat-box.green{background:#e8f5e9}
    .stat-box.blue{background:#e3f2fd}
    .stat-box.purple{background:#f3e5f5}
    .stat-box.orange{background:#fff3e0}
    .stat-value{font-size:1.4em;font-weight:700;color:#333}
    .stat-label{font-size:0.55em;color:#888}
    .timeline-item{display:flex;gap:10px;margin-bottom:8px}
    .timeline-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7em;font-weight:700;flex-shrink:0}
    .timeline-dot.done{background:#4caf50;color:#fff}
    .timeline-dot.current{background:#ffd54f;color:#333}
    .timeline-dot.future{background:#e0e0e0;color:#999}
    .timeline-content{flex:1;padding:10px;border-radius:10px;font-size:0.8em}
    .timeline-content.done{background:#e8f5e9}
    .timeline-content.current{background:#fffde7;border:2px solid #ffd54f}
    .timeline-content.future{background:#f5f5f5}
    .timeline-title{font-weight:600}
    .timeline-date{font-size:0.85em;color:#888}
    .timeline-percent{float:right;padding:2px 8px;border-radius:10px;font-size:0.8em}
    .timeline-percent.complete{background:#4caf50;color:#fff}
    .timeline-percent.partial{background:#ffe082}
    .growth-item{background:#f5f5f5;padding:10px;border-radius:10px;margin-bottom:6px;position:relative}
    .growth-header{display:flex;justify-content:space-between;margin-bottom:4px;padding-right:30px}
    .growth-day{font-weight:700;color:#2e7d32;font-size:0.85em}
    .growth-date{font-size:0.65em;color:#999}
    .growth-tags{display:flex;flex-wrap:wrap;gap:4px}
    .growth-tag{padding:3px 8px;border-radius:8px;font-size:0.7em}
    .growth-tag.height{background:#e3f2fd;color:#1565c0}
    .growth-tag.leaves{background:#e8f5e9;color:#2e7d32}
    .growth-tag.problem{background:#ffebee;color:#c62828}
    .delete-btn{position:absolute;top:8px;right:8px;background:#ef5350;color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:0.9em}
    .plot-selector{display:flex;gap:8px;margin-bottom:10px;overflow-x:auto;padding-bottom:4px}
    .plot-btn{padding:8px 14px;background:#f5f5f5;border:2px solid transparent;border-radius:12px;cursor:pointer;font-size:0.8em;white-space:nowrap;display:flex;align-items:center;gap:6px;flex-shrink:0}
    .plot-btn.active{background:#4caf50;color:#fff}
    .add-plot-btn{background:#e3f2fd;color:#1976d2;border:2px dashed #90caf9}
    .plot-card{background:linear-gradient(135deg,#4caf50,#2e7d32);border-radius:16px;padding:14px;color:#fff;margin-bottom:10px}
    .plot-card .header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .plot-card .icon{font-size:2em}
    .plot-card .title{font-size:1.1em;font-weight:700}
    .plot-card .dates{font-size:0.75em;opacity:0.9}
    .plot-card .progress{background:rgba(255,255,255,0.2);border-radius:10px;padding:8px;margin-top:8px}
    .plot-card .bar{height:10px;background:rgba(255,255,255,0.3);border-radius:5px;overflow:hidden}
    .plot-card .fill{height:100%;background:#fff}
    .plot-card .text{display:flex;justify-content:space-between;font-size:0.7em;margin-top:4px}
    .chart-container{position:relative;height:220px;margin:10px 0}
    .warning-box{background:#ffebee;border:2px solid #ef9a9a;border-radius:12px;padding:12px;margin-bottom:10px}
    .warning-box h3{color:#c62828;font-size:0.85em;margin-bottom:8px}
    .warning-box ul{list-style:none;font-size:0.75em}
    .warning-box li{display:flex;gap:6px;margin-bottom:6px}
    .schedule-table{background:#e8f5e9;border-radius:12px;padding:12px}
    .schedule-table h3{color:#2e7d32;font-size:0.85em;margin-bottom:8px}
    .schedule-row{display:flex;justify-content:space-between;padding:8px;background:#fff;border-radius:8px;margin-bottom:4px;font-size:0.75em}
    .veggie-info{display:flex;gap:10px}
    .veggie-icon{font-size:2.5em}
    .veggie-name{font-weight:700;color:#2e7d32}
    .veggie-desc{font-size:0.75em;color:#666;margin:4px 0}
    .veggie-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px}
    .veggie-stat{background:#f5f5f5;padding:6px 8px;border-radius:8px;font-size:0.7em}
    .veggie-tip{font-size:0.75em;color:#43a047;margin-top:8px}
    .bio-accordion{border:2px solid;border-radius:12px;margin-bottom:8px;overflow:hidden}
    .bio-accordion-header{padding:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
    .bio-accordion-header .info{display:flex;align-items:center;gap:8px}
    .bio-accordion-header .icon{font-size:1.5em}
    .bio-accordion-header .name{font-weight:700;font-size:0.9em}
    .bio-accordion-header .fullname{font-size:0.65em;opacity:0.7}
    .bio-accordion-header .arrow{transition:transform 0.3s}
    .bio-accordion.open .arrow{transform:rotate(180deg)}
    .bio-accordion-body{padding:0 12px 12px;display:none}
    .bio-accordion.open .bio-accordion-body{display:block}
    .bio-info-box{background:rgba(255,255,255,0.5);padding:8px;border-radius:8px;margin-bottom:6px;font-size:0.75em}
    .bio-info-box b{display:block;margin-bottom:2px}
    .bio-info-box ul{margin:0;padding-left:16px}
    .empty-state{text-align:center;padding:40px 20px}
    .empty-state .icon{font-size:3em;margin-bottom:10px}
    .empty-state p{color:#888;margin-bottom:10px}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal-content{background:#fff;border-radius:16px;padding:20px;max-width:400px;width:100%;max-height:80vh;overflow-y:auto}
    .modal-content h2{color:#2e7d32;margin-bottom:15px}
    .sync-badge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:12px;font-size:0.7em;background:#e8f5e9;color:#2e7d32}
    .sync-badge.syncing{background:#fff3e0;color:#e65100}
    .sync-badge.error{background:#ffebee;color:#c62828}
    .footer{text-align:center;font-size:0.6em;color:#4caf50;padding:10px 0}
  </style>
</head>
<body>
  <div class="container">
    <h1>üå± ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå</h1>
    <p class="subtitle">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏´‡∏•‡∏≤‡∏¢‡πÅ‡∏õ‡∏•‡∏á | ‡∏Å‡∏£‡∏≤‡∏ü | PDF | <span id="syncBadge" class="sync-badge">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span></p>
    
    <div id="mainApp">
      <div id="planner" class="tab-content active">
        <div id="plotSelector" class="plot-selector"></div>
        <div id="plannerContent"></div>
      </div>
      <div id="today" class="tab-content"><div id="todayContent"></div></div>
      <div id="progress" class="tab-content"><div id="progressContent"></div></div>
      <div id="record" class="tab-content"><div id="recordContent"></div></div>
      <div id="guide" class="tab-content"><div id="guideContent"></div></div>
    </div>
    
    <p class="footer">üåø ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ú‡πà‡∏≤‡∏ô Firebase Realtime Database üåø</p>
  </div>
  
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="showTab('planner')"><span class="icon">ü™¥</span><span>‡πÅ‡∏õ‡∏•‡∏á</span></button>
    <button class="nav-btn" onclick="showTab('today')"><span class="icon">üìÖ</span><span>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></button>
    <button class="nav-btn" onclick="showTab('progress')"><span class="icon">üìä</span><span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span></button>
    <button class="nav-btn" onclick="showTab('record')"><span class="icon">üìù</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></button>
    <button class="nav-btn" onclick="showTab('guide')"><span class="icon">üìñ</span><span>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</span></button>
  </nav>
  
  <div id="modal" class="modal hidden"><div class="modal-content" id="modalContent"></div></div>

<script>
// ==================== Firebase Config ====================
const firebaseConfig = {
  apiKey: "AIzaSyDVnLYb27BPs_RM-YY6ASBgkYAiKSPMULM",
  authDomain: "organic-vegetable-planting.firebaseapp.com",
  databaseURL: "https://organic-vegetable-planting-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "organic-vegetable-planting",
  storageBucket: "organic-vegetable-planting.firebasestorage.app",
  messagingSenderId: "384351483160",
  appId: "1:384351483160:web:008a9797fcd2e9f7819a6d"
};

let db = null;

// ==================== Data ====================
const saladVeggies = {
  greenoak: { name: '‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ', icon: 'ü•¨', days: 45, germDays: 3, desc: '‡πÉ‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô ‡∏£‡∏™‡∏Å‡∏£‡∏≠‡∏ö', tips: '‡∏ä‡∏≠‡∏ö‡πÅ‡∏î‡∏î‡∏£‡∏≥‡πÑ‡∏£ ‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏£‡∏≥‡πÑ‡∏£ 4-6 ‡∏ä‡∏°.' },
  redoak: { name: '‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ', icon: 'ü•ó', days: 45, germDays: 3, desc: '‡πÉ‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á', tips: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏á‡πÅ‡∏î‡∏î‡πÉ‡∏´‡πâ‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏™‡∏ß‡∏¢', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 5-6 ‡∏ä‡∏°.' },
  butterhead: { name: '‡∏ö‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Æ‡∏î', icon: 'ü•¨', days: 50, germDays: 4, desc: '‡πÉ‡∏ö‡∏ô‡∏∏‡πà‡∏° ‡∏£‡∏™‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô', tips: '‡∏ä‡∏≠‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô ‡∏£‡∏∞‡∏ß‡∏±‡∏á‡∏ô‡πâ‡∏≥‡∏Ç‡∏±‡∏á', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏≠‡πà‡∏≠‡∏ô 4-5 ‡∏ä‡∏°.' },
  cos: { name: '‡∏Å‡∏£‡∏µ‡∏ô‡∏Ñ‡∏≠‡∏™', icon: 'ü•ó', days: 55, germDays: 4, desc: '‡πÉ‡∏ö‡∏¢‡∏≤‡∏ß‡∏Å‡∏£‡∏≠‡∏ö ‡∏ó‡∏≥‡∏™‡∏•‡∏±‡∏î', tips: '‡∏ó‡∏ô‡πÅ‡∏î‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏≤‡∏Å', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 5-7 ‡∏ä‡∏°.' },
  filley: { name: '‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏¢‡πå', icon: 'üåø', days: 40, germDays: 3, desc: '‡πÉ‡∏ö‡∏´‡∏¢‡∏±‡∏Å ‡πÇ‡∏ï‡πÄ‡∏£‡πá‡∏ß', tips: '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏£‡∏≥‡πÑ‡∏£ 4-5 ‡∏ä‡∏°.' }
};

const thaiVeggies = {
  kana: { name: '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤', icon: 'ü•¨', days: 50, germDays: 4, desc: '‡∏ú‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á', tips: '‡∏õ‡∏•‡∏π‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 5-6 ‡∏ä‡∏°.' },
  pakbung: { name: '‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á‡∏à‡∏µ‡∏ô', icon: 'üåø', days: 25, germDays: 3, desc: '‡πÇ‡∏ï‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å ‡∏õ‡∏•‡∏π‡∏Å‡∏á‡πà‡∏≤‡∏¢', tips: '‡πÅ‡∏ä‡πà‡πÄ‡∏°‡∏•‡πá‡∏î 12 ‡∏ä‡∏°.', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 5-6 ‡∏ä‡∏°.' },
  pakchoi: { name: '‡∏ú‡∏±‡∏Å‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á', icon: 'ü•¨', days: 35, germDays: 3, desc: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô ‡πÇ‡∏ï‡πÑ‡∏ß', tips: '‡∏ä‡∏≠‡∏ö‡πÅ‡∏î‡∏î ‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 5-6 ‡∏ä‡∏°.' },
  kaprao: { name: '‡∏Å‡∏∞‡πÄ‡∏û‡∏£‡∏≤', icon: 'üåø', days: 35, germDays: 5, desc: '‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≠‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á', tips: '‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏ï‡∏Å‡∏Å‡∏¥‡πà‡∏á', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 6-8 ‡∏ä‡∏°.' },
  horapha: { name: '‡πÇ‡∏´‡∏£‡∏∞‡∏û‡∏≤', icon: 'üåø', days: 40, germDays: 5, desc: '‡∏´‡∏≠‡∏° ‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£', tips: '‡∏î‡∏¥‡∏ô‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏ô‡πâ‡∏≥‡∏î‡∏µ', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏à‡∏±‡∏î 6-8 ‡∏ä‡∏°.' },
  pakchi: { name: '‡∏ú‡∏±‡∏Å‡∏ä‡∏µ', icon: 'üå±', days: 45, germDays: 7, desc: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°', tips: '‡∏ö‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏≤‡∏∞', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏£‡∏≥‡πÑ‡∏£ 3-4 ‡∏ä‡∏°.' },
  tonhom: { name: '‡∏ï‡πâ‡∏ô‡∏´‡∏≠‡∏°', icon: 'üå±', days: 35, germDays: 5, desc: '‡πÉ‡∏ä‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡πâ‡∏≠‡∏¢', tips: '‡∏õ‡∏•‡∏π‡∏Å‡∏à‡∏≤‡∏Å‡∏´‡∏±‡∏ß‡πÑ‡∏î‡πâ', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 1-2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '‡πÅ‡∏î‡∏î‡∏£‡∏≥‡πÑ‡∏£ 4-5 ‡∏ä‡∏°.' }
};

const bioProducts = {
  em: { name: 'EM ‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå', icon: 'ü¶†', color: 'em', fullName: 'Effective Microorganisms', ratio: '1 ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞ : ‡∏ô‡πâ‡∏≥ 10 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏ó‡∏∏‡∏Å 5-7 ‡∏ß‡∏±‡∏ô', how: '‡∏£‡∏î‡∏£‡∏≤‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏ô‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡πÉ‡∏ö', benefits: ['‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô', '‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏•‡∏≤‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏', '‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ‡πÉ‡∏ô‡∏î‡∏¥‡∏ô'], tips: '‡∏£‡∏≤‡∏î‡∏î‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å 7 ‡∏ß‡∏±‡∏ô', storage: '‡πÄ‡∏Å‡πá‡∏ö 25-45¬∞C ‡πÑ‡∏î‡πâ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
  tricho: { name: '‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏≤', icon: 'üçÑ', color: 'tricho', fullName: 'Trichoderma', ratio: '25 ‡∏Å‡∏£‡∏±‡∏° : ‡∏ô‡πâ‡∏≥ 20 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏ó‡∏∏‡∏Å 5-7 ‡∏ß‡∏±‡∏ô ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô', how: '‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡πÉ‡∏ö ‡∏Å‡∏¥‡πà‡∏á ‡∏•‡∏≥‡∏ï‡πâ‡∏ô', benefits: ['‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡πà‡∏≤‡∏Ñ‡∏≠‡∏î‡∏¥‡∏ô', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÉ‡∏ö‡πÑ‡∏´‡∏°‡πâ', '‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô'], tips: '‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î 10g:1kg', storage: '‡∏ï‡∏π‡πâ‡πÄ‡∏¢‡πá‡∏ô 1 ‡∏õ‡∏µ' },
  beauveria: { name: '‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢', icon: 'ü¶ü', color: 'beau', fullName: 'Beauveria bassiana', ratio: '50 ‡∏Å‡∏£‡∏±‡∏° : ‡∏ô‡πâ‡∏≥ 20 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á ‡∏ó‡∏∏‡∏Å 5-7 ‡∏ß‡∏±‡∏ô', how: '‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏°‡∏•‡∏á‡∏≠‡∏¢‡∏π‡πà', benefits: ['‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏≠‡πà‡∏≠‡∏ô', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÅ‡∏õ‡πâ‡∏á', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏ß‡∏µ‡πà‡∏Ç‡∏≤‡∏ß', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡πÑ‡∏ü'], tips: '‡∏â‡∏µ‡∏î‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô', storage: '‡∏ó‡∏µ‡πà‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏´‡πâ‡∏á 3-6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
  metarhizium: { name: '‡πÄ‡∏°‡∏ï‡∏≤‡πÑ‡∏£‡πÄ‡∏ã‡∏µ‡∏¢‡∏°', icon: 'ü™≤', color: 'meta', fullName: 'Metarhizium anisopliae', ratio: '50 ‡∏Å‡∏£‡∏±‡∏° : ‡∏ô‡πâ‡∏≥ 20 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á ‡∏ó‡∏∏‡∏Å 5-7 ‡∏ß‡∏±‡∏ô', how: '‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≤‡∏î‡∏î‡∏¥‡∏ô', benefits: ['‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏á‡∏´‡∏°‡∏±‡∏î‡∏ú‡∏±‡∏Å', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÑ‡∏£‡πÅ‡∏î‡∏á', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏´‡∏ô‡∏≠‡∏ô‡∏Å‡∏≠', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á‡∏õ‡∏µ‡∏Å‡πÅ‡∏Ç‡πá‡∏á'], tips: '‡∏£‡∏≤‡∏î‡∏î‡∏¥‡∏ô‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏´‡∏ô‡∏≠‡∏ô', storage: '‡∏ó‡∏µ‡πà‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏´‡πâ‡∏á 3-6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
  hormone: { name: '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡∏û‡∏∑‡∏ä', icon: 'üåø', color: 'hormone', fullName: '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ', ratio: '4-5 ‡∏ä‡πâ‡∏≠‡∏ô‡πÇ‡∏ï‡πä‡∏∞ : ‡∏ô‡πâ‡∏≥ 10 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏ó‡∏∏‡∏Å 7-10 ‡∏ß‡∏±‡∏ô', how: '‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ó‡∏±‡πà‡∏ß‡∏ï‡πâ‡∏ô', benefits: ['‡πÄ‡∏£‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', '‡∏ú‡∏±‡∏Å‡∏≠‡∏ß‡∏ö‡∏´‡∏ß‡∏≤‡∏ô‡∏Å‡∏£‡∏≠‡∏ö', '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏•‡∏ú‡∏•‡∏¥‡∏ï', '‡πÉ‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏ß‡∏¢'], tips: '‡∏ó‡∏≥‡πÄ‡∏≠‡∏á: ‡∏°‡∏∞‡∏•‡∏∞‡∏Å‡∏≠+‡∏ü‡∏±‡∏Å‡∏ó‡∏≠‡∏á+‡∏Å‡∏•‡πâ‡∏ß‡∏¢+EM ‡∏´‡∏°‡∏±‡∏Å 7-8 ‡∏ß‡∏±‡∏ô', storage: '‡∏Ç‡∏ß‡∏î‡∏õ‡∏¥‡∏î‡∏™‡∏ô‡∏¥‡∏ó 3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' }
};

// ==================== State ====================
let plots = [], currentPlotId = null, chartInstance = null;
const $ = id => document.getElementById(id);
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
const formatDate = d => new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
const formatDateFull = d => new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
const getDaysDiff = (d1, d2) => Math.floor((new Date(d1) - new Date(d2)) / 86400000);
const today = new Date(); today.setHours(0,0,0,0);
const todayKey = today.toISOString().split('T')[0];

// ==================== Firebase Functions ====================
function updateSyncBadge(status, text) {
  const badge = $('syncBadge');
  badge.className = 'sync-badge ' + status;
  badge.innerHTML = text;
}

function saveToFirebase() {
  if (!db) return;
  updateSyncBadge('syncing', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
  db.ref('veggie-app-v3').set({ plots, currentPlotId })
    .then(() => updateSyncBadge('', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß'))
    .catch(err => updateSyncBadge('error', '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'));
}

function loadFromFirebase() {
  if (!db) return;
  db.ref('veggie-app-v3').on('value', snap => {
    const data = snap.val();
    if (data) {
      plots = (data.plots || []).map(p => ({
        ...p,
        completedTasks: p.completedTasks || {},
        dailyLogs: p.dailyLogs || {},
        growthLogs: p.growthLogs || [],
        phases: p.phases || []
      }));
      currentPlotId = data.currentPlotId || (plots[0]?.id || null);
    }
    updateSyncBadge('', '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
    renderAll();
  }, err => {
    updateSyncBadge('error', '‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
  });
}

// ==================== Navigation ====================
function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(t => t.classList.remove('active'));
  $(tabId).classList.add('active');
  document.querySelector(`.nav-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
  renderCurrentTab();
}

function renderCurrentTab() {
  const active = document.querySelector('.tab-content.active');
  if (active?.id === 'planner') renderPlanner();
  if (active?.id === 'today') renderToday();
  if (active?.id === 'progress') renderProgress();
  if (active?.id === 'record') renderRecord();
  if (active?.id === 'guide') renderGuide();
}

function renderAll() { renderPlotSelector(); renderCurrentTab(); }

// ==================== Plot Management ====================
function renderPlotSelector() {
  let html = plots.map(p => `<button class="plot-btn ${p.id === currentPlotId ? 'active' : ''}" onclick="selectPlot('${p.id}')">${p.veggie?.icon || 'üå±'} ${p.name}</button>`).join('');
  html += `<button class="plot-btn add-plot-btn" onclick="showAddPlotModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á</button>`;
  $('plotSelector').innerHTML = html;
}

function selectPlot(id) { currentPlotId = id; saveToFirebase(); renderAll(); }
function getCurrentPlot() { return plots.find(p => p.id === currentPlotId); }

function showAddPlotModal() {
  $('modalContent').innerHTML = `
    <h2>üå± ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡∏ú‡∏±‡∏Å‡πÉ‡∏´‡∏°‡πà</h2>
    <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á</label><input type="text" id="plotName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏õ‡∏•‡∏á A"></div>
    <div class="form-row">
      <div class="form-group"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label><select id="category" onchange="updateVeggieOpts()"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option><option value="salad">ü•ó ‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î</option><option value="thai">üåø ‡∏ú‡∏±‡∏Å‡πÑ‡∏ó‡∏¢</option></select></div>
      <div class="form-group"><label>‡∏ä‡∏ô‡∏¥‡∏î</label><select id="veggieType"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option></select></div>
    </div>
    <div class="form-group"><label>üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏õ‡∏•‡∏π‡∏Å</label><input type="date" id="startDate" value="${todayKey}"></div>
    <div class="btn-row"><button class="btn" onclick="createPlot()">üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏á</button><button class="btn btn-danger" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>`;
  $('modal').classList.remove('hidden');
}

function updateVeggieOpts() {
  const cat = $('category')?.value, sel = $('veggieType');
  if (!sel) return;
  sel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
  const data = cat === 'salad' ? saladVeggies : cat === 'thai' ? thaiVeggies : {};
  Object.entries(data).forEach(([k, v]) => sel.innerHTML += `<option value="${k}">${v.icon} ${v.name}</option>`);
}

function createPlot() {
  const name = $('plotName').value.trim() || `‡πÅ‡∏õ‡∏•‡∏á ${plots.length + 1}`;
  const cat = $('category').value, type = $('veggieType').value, startDateStr = $('startDate').value;
  if (!cat || !type || !startDateStr) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  
  const veggie = (cat === 'salad' ? saladVeggies : thaiVeggies)[type];
  const start = new Date(startDateStr);
  const phases = generatePhases(veggie, start);
  
  const newPlot = { id: genId(), name, veggie, startDate: start.toISOString(), phases, completedTasks: {}, dailyLogs: {}, growthLogs: [] };
  plots.push(newPlot);
  currentPlotId = newPlot.id;
  saveToFirebase(); closeModal(); renderAll();
}

function generatePhases(veggie, start) {
  return [
    { id: 'prep', day: -7, name: 'üîß ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏¥‡∏ô', desc: '‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô ‡∏ú‡∏™‡∏°‡∏õ‡∏∏‡πã‡∏¢ ‡∏£‡∏≤‡∏î EM', bio: ['em', 'tricho'], tasks: ['‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏ã‡∏∏‡∏¢', '‡∏ú‡∏™‡∏°‡∏î‡∏¥‡∏ô:‡∏õ‡∏∏‡πã‡∏¢:‡∏Ç‡∏∏‡∏¢‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß 2:1:1', '‡∏£‡∏≤‡∏î EM', '‡πÇ‡∏£‡∏¢‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏≤', '‡∏Ñ‡∏•‡∏∏‡∏°‡∏ü‡∏≤‡∏á', '‡∏£‡∏≠‡∏´‡∏°‡∏±‡∏Å 7 ‡∏ß‡∏±‡∏ô'] },
    { id: 'plant', day: 0, name: 'üå± ‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', bio: ['tricho'], tasks: ['‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', '‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î', '‡∏Å‡∏•‡∏ö‡∏î‡∏¥‡∏ô‡∏ö‡∏≤‡∏á', '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ä‡∏∏‡πà‡∏°', '‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏£‡πà‡∏°', '‡∏ï‡∏¥‡∏î‡∏õ‡πâ‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠'] },
    { id: 'germ', day: veggie.germDays, name: 'üåø ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏á‡∏≠‡∏Å', desc: '‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏ú‡∏•‡πà', bio: ['em'], tasks: ['‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', '‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô', '‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á', '‡∏£‡∏î EM', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ üì∏'] },
    { id: 'care1', day: 7, name: 'üíß ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå 1', desc: '‡∏£‡∏î EM ‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', bio: ['em', 'tricho'], tasks: ['‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô', '‡∏£‡∏î EM', '‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', '‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á', '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏°‡∏•‡∏á'] },
    { id: 'hormone1', day: 10, name: 'üåø ‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô 1', desc: '‡∏â‡∏µ‡∏î‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡πÄ‡∏£‡πà‡∏á‡πÉ‡∏ö', bio: ['hormone'], tasks: ['‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô', '‡∏â‡∏µ‡∏î‡∏ó‡∏±‡πà‡∏ß‡∏ï‡πâ‡∏ô', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ'] },
    { id: 'transplant', day: 14, name: 'ü™¥ ‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡πÅ‡∏õ‡∏•‡∏á', bio: ['tricho'], tasks: ['‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏•‡∏∏‡∏°', '‡πÉ‡∏™‡πà‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡πâ‡∏ô', '‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', '‡∏£‡∏î‡∏ô‡πâ‡∏≥', '‡∏û‡∏£‡∏≤‡∏á‡πÅ‡∏™‡∏á'] },
    { id: 'pest', day: 17, name: 'ü¶ü ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏°‡∏•‡∏á', desc: '‡∏â‡∏µ‡∏î‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå', bio: ['beauveria', 'metarhizium'], tasks: ['‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ï‡πâ‡πÉ‡∏ö', '‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏ô‡∏≠‡∏ô', '‡∏â‡∏µ‡∏î‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢', '‡∏â‡∏µ‡∏î‡πÄ‡∏°‡∏ï‡∏≤‡πÑ‡∏£‡πÄ‡∏ã‡∏µ‡∏¢‡∏°'] },
    { id: 'care2', day: 21, name: 'üíß ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå 3', desc: 'EM + ‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ ‡∏£‡∏≠‡∏ö 2', bio: ['em', 'tricho'], tasks: ['‡∏£‡∏î EM', '‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', '‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä', '‡∏ß‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á'] },
    { id: 'hormone2', day: 25, name: 'üåø ‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô 2', desc: '‡∏â‡∏µ‡∏î‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô ‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô', bio: ['hormone'], tasks: ['‡∏â‡∏µ‡∏î‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô', '‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô', '‡∏ï‡∏£‡∏ß‡∏à‡πÇ‡∏£‡∏Ñ', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ'] },
    { id: 'grow', day: Math.floor(veggie.days * 0.8), name: 'ü•¨ ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Å‡πá‡∏ö', desc: '‡∏ï‡πâ‡∏ô‡πÇ‡∏ï‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà', bio: ['tricho'], tasks: ['‡∏ï‡∏£‡∏ß‡∏à‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä', '‡∏£‡∏î EM ‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ', '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'] },
    { id: 'stop', day: veggie.days - 5, name: '‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå', desc: '‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö', bio: [], tasks: ['‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏µ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤', '‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏Å‡πá‡∏ö'] },
    { id: 'harvest', day: veggie.days, name: 'üéâ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß!', desc: '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡∏™‡∏î!', bio: [], tasks: ['‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö', '‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤', '‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏ô', '‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î', '‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ üéä'] }
  ].map(p => ({ ...p, date: addDays(start, p.day).toISOString() }));
}

function closeModal() { $('modal').classList.add('hidden'); }
function deletePlot(id) {
  if (!confirm('‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ?')) return;
  plots = plots.filter(p => p.id !== id);
  if (currentPlotId === id) currentPlotId = plots[0]?.id || null;
  saveToFirebase(); renderAll();
}

// ==================== Phase & Tasks ====================
function getCurrentPhase(plot) {
  if (!plot) return null;
  return [...plot.phases].sort((a, b) => new Date(b.date) - new Date(a.date)).find(p => new Date(p.date) <= today) || plot.phases[0];
}
function getNextPhase(plot) { return plot?.phases.find(p => new Date(p.date) > today); }
function getPhaseCompletion(plot, phase) {
  if (!plot || !phase || !phase.tasks) return 0;
  const tasks = plot.completedTasks || {};
  const done = phase.tasks.filter((_, i) => tasks[`${phase.id}-${i}`]).length;
  return Math.round((done / phase.tasks.length) * 100);
}
function toggleTask(plotId, phaseId, taskIdx) {
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  if (!plot.completedTasks) plot.completedTasks = {};
  plot.completedTasks[`${phaseId}-${taskIdx}`] = !plot.completedTasks[`${phaseId}-${taskIdx}`];
  saveToFirebase(); renderCurrentTab();
}
function logDaily(plotId, type) {
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  if (!plot.dailyLogs) plot.dailyLogs = {};
  if (!plot.dailyLogs[todayKey]) plot.dailyLogs[todayKey] = {};
  plot.dailyLogs[todayKey][type] = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
  saveToFirebase(); renderCurrentTab();
}

// ==================== Growth Log ====================
function validateNum(val, min = 0, max = 1000) {
  const num = parseFloat(val);
  if (isNaN(num)) return { ok: false, err: '‡∏Å‡∏£‡∏≠‡∏Å‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç' };
  if (num < min) return { ok: false, err: `‡∏ï‡πâ‡∏≠‡∏á >= ${min}` };
  if (num > max) return { ok: false, err: `‡∏ï‡πâ‡∏≠‡∏á <= ${max}` };
  return { ok: true, val: num };
}

function addGrowthLog(plotId) {
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  
  const hInput = $('newHeight'), lInput = $('newLeaves'), pInput = $('problemLog');
  hInput.classList.remove('error'); lInput.classList.remove('error');
  document.querySelectorAll('.error-msg').forEach(e => e.remove());
  
  const h = hInput.value.trim(), l = lInput.value.trim(), p = pInput.value.trim();
  if (!h && !l) { alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö'); return; }
  
  let hasErr = false, vH = null, vL = null;
  if (h) { const r = validateNum(h, 0, 500); if (!r.ok) { hInput.classList.add('error'); hInput.insertAdjacentHTML('afterend', `<div class="error-msg">${r.err}</div>`); hasErr = true; } else vH = r.val; }
  if (l) { const r = validateNum(l, 0, 1000); if (!r.ok) { lInput.classList.add('error'); lInput.insertAdjacentHTML('afterend', `<div class="error-msg">${r.err}</div>`); hasErr = true; } else vL = r.val; }
  if (hasErr) return;
  
  if (!plot.growthLogs) plot.growthLogs = [];
  plot.growthLogs.push({ id: genId(), date: new Date().toISOString(), day: getDaysDiff(today, plot.startDate) + 1, height: vH, leaves: vL, problem: p });
  hInput.value = ''; lInput.value = ''; pInput.value = '';
  saveToFirebase(); renderCurrentTab();
}

function deleteGrowthLog(plotId, logId) {
  if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  plot.growthLogs = plot.growthLogs.filter(l => l.id !== logId);
  saveToFirebase(); renderCurrentTab();
}

// ==================== Render Functions ====================
function renderPlanner() {
  const plot = getCurrentPlot();
  if (!plot) { $('plannerContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p><p style="font-size:0.8em;color:#666;">‡∏Ñ‡∏•‡∏¥‡∏Å "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á"</p></div>`; return; }
  
  const dayNum = getDaysDiff(today, plot.startDate) + 1;
  const daysLeft = Math.max(0, getDaysDiff(addDays(new Date(plot.startDate), plot.veggie.days), today));
  const pct = Math.min(100, Math.max(0, Math.round((getDaysDiff(today, addDays(new Date(plot.startDate), -7)) / (plot.veggie.days + 7)) * 100)));
  
  let html = `<div class="plot-card"><div class="header"><div class="icon">${plot.veggie.icon}</div><div><div class="title">${plot.name} - ${plot.veggie.name}</div><div class="dates">‡πÄ‡∏£‡∏¥‡πà‡∏° ${formatDate(plot.startDate)} ‚Üí ‡πÄ‡∏Å‡πá‡∏ö ${formatDate(addDays(new Date(plot.startDate), plot.veggie.days))}</div></div></div><div class="progress"><div class="bar"><div class="fill" style="width:${pct}%"></div></div><div class="text"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayNum} ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft} ‡∏ß‡∏±‡∏ô</span><span>${pct}%</span></div></div></div>`;
  
  html += `<div class="card"><h2>üå± ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏±‡∏Å</h2><div class="veggie-info"><div class="veggie-icon">${plot.veggie.icon}</div><div class="veggie-details"><div class="veggie-name">${plot.veggie.name}</div><div class="veggie-desc">${plot.veggie.desc}</div><div class="veggie-grid"><div class="veggie-stat">‚è±Ô∏è ${plot.veggie.days} ‡∏ß‡∏±‡∏ô</div><div class="veggie-stat">üå± ‡∏á‡∏≠‡∏Å ${plot.veggie.germDays} ‡∏ß‡∏±‡∏ô</div><div class="veggie-stat">üíß ${plot.veggie.water}</div><div class="veggie-stat">‚òÄÔ∏è ${plot.veggie.light}</div></div><div class="veggie-tip">üí° ${plot.veggie.tips}</div></div></div></div>`;
  
  html += `<div class="btn-row" style="margin-bottom:10px;"><button class="btn btn-blue btn-sm" onclick="exportPDF('${plot.id}')">üì§ Export PDF</button><button class="btn btn-danger btn-sm" onclick="deletePlot('${plot.id}')">üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á</button></div>`;
  
  $('plannerContent').innerHTML = html;
}

function renderToday() {
  const plot = getCurrentPlot();
  if (!plot) { $('todayContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p></div>`; return; }
  
  const current = getCurrentPhase(plot), next = getNextPhase(plot);
  const dayNum = getDaysDiff(today, plot.startDate) + 1;
  const daysLeft = Math.max(0, getDaysDiff(addDays(new Date(plot.startDate), plot.veggie.days), today));
  const pct = Math.min(100, Math.max(0, Math.round((getDaysDiff(today, addDays(new Date(plot.startDate), -7)) / (plot.veggie.days + 7)) * 100)));
  const todayLog = (plot.dailyLogs || {})[todayKey] || {};
  
  let html = `<div class="status-card"><h2>üìÖ ${formatDateFull(today)}</h2><p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayNum} - ${plot.name} ${plot.veggie.icon}</p><div class="status-badges"><span class="status-badge">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft} ‡∏ß‡∏±‡∏ô</span><span class="status-badge">${pct}%</span></div></div>`;
  
  if (current) {
    const comp = getPhaseCompletion(plot, current);
    const tasks = plot.completedTasks || {};
    const tasksDoneCount = current.tasks.filter((_, i) => tasks[`${current.id}-${i}`]).length;
    html += `<div class="card phase-card"><div class="phase-header"><span class="phase-title">${current.name}</span><span class="phase-badge">üéØ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span></div><p class="phase-desc">${current.desc}</p>${current.bio.length ? `<div class="bio-tags">${current.bio.map(b => `<span class="bio-tag bio-${bioProducts[b].color}">${bioProducts[b].icon} ${bioProducts[b].name}</span>`).join('')}</div>` : ''}<p style="font-size:0.8em;font-weight:600;color:#555;margin-bottom:8px;">üìù (${tasksDoneCount}/${current.tasks.length}):</p><ul class="checklist">${current.tasks.map((t, i) => `<li class="${tasks[`${current.id}-${i}`] ? 'done' : ''}" onclick="toggleTask('${plot.id}', '${current.id}', ${i})"><input type="checkbox" ${tasks[`${current.id}-${i}`] ? 'checked' : ''}><span>${t}</span></li>`).join('')}</ul><div class="progress-wrap"><div class="progress-bar" style="width:${comp}%"></div></div><div class="progress-text"><span>‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span><span>${comp}%</span></div></div>`;
  }
  
  const quickBtns = [{id:'water_am',icon:'üíß',label:'‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤'},{id:'water_pm',icon:'üíß',label:'‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô'},{id:'check',icon:'üîç',label:'‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πâ‡∏ô'},{id:'em',icon:'ü¶†',label:'‡πÉ‡∏´‡πâ EM'},{id:'tricho',icon:'üçÑ',label:'‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ'},{id:'photo',icon:'üì∏',label:'‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ'}];
  html += `<div class="card"><h2>‚ö° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô</h2><div class="quick-btns">${quickBtns.map(item => `<button class="quick-btn ${todayLog[item.id] ? 'done' : ''}" onclick="logDaily('${plot.id}', '${item.id}')"><span class="icon">${item.icon}</span><span class="label">${item.label}</span>${todayLog[item.id] ? `<span class="time">‚úì ${todayLog[item.id]}</span>` : ''}</button>`).join('')}</div></div>`;
  
  if (next) html += `<div class="card" style="background:#e3f2fd;border-left:4px solid #2196f3;"><h3 style="color:#1565c0;font-size:0.85em;">‚è≠Ô∏è ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${next.name}</h3><p style="font-size:0.75em;color:#1565c0;">üìÖ ${formatDate(next.date)} (‡∏≠‡∏µ‡∏Å ${getDaysDiff(new Date(next.date), today)} ‡∏ß‡∏±‡∏ô)</p></div>`;
  
  $('todayContent').innerHTML = html;
}

function renderProgress() {
  const plot = getCurrentPlot();
  if (!plot) { $('progressContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p></div>`; return; }
  
  const dayNum = Math.max(1, getDaysDiff(today, plot.startDate) + 1);
  const daysLeft = Math.max(0, getDaysDiff(addDays(new Date(plot.startDate), plot.veggie.days), today));
  const pct = Math.min(100, Math.max(0, Math.round((getDaysDiff(today, addDays(new Date(plot.startDate), -7)) / (plot.veggie.days + 7)) * 100)));
  const tasksDone = Object.values(plot.completedTasks).filter(Boolean).length;
  const current = getCurrentPhase(plot);
  
  let html = `<div class="card"><h2>üìà ${plot.name}</h2><div class="stats-grid"><div class="stat-box green"><div class="stat-value">${dayNum}</div><div class="stat-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div></div><div class="stat-box blue"><div class="stat-value">${tasksDone}</div><div class="stat-label">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</div></div><div class="stat-box purple"><div class="stat-value">${daysLeft}</div><div class="stat-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div></div><div class="stat-box orange"><div class="stat-value">${pct}%</div><div class="stat-label">‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div></div></div></div>`;
  
  if (plot.growthLogs && plot.growthLogs.length >= 2) html += `<div class="card"><h2>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2><div class="chart-container"><canvas id="growthChart"></canvas></div></div>`;
  
  html += `<div class="card"><h2>üìä ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</h2>${plot.phases.map((phase, idx) => {
    const isPast = new Date(phase.date) < today, isCurrent = current?.id === phase.id, comp = getPhaseCompletion(plot, phase);
    return `<div class="timeline-item"><div class="timeline-dot ${isCurrent ? 'current' : isPast ? 'done' : 'future'}">${isPast && comp === 100 ? '‚úì' : idx + 1}</div><div class="timeline-content ${isCurrent ? 'current' : isPast ? 'done' : 'future'}"><span class="timeline-title">${phase.name}</span>${(isPast || isCurrent) ? `<span class="timeline-percent ${comp === 100 ? 'complete' : 'partial'}">${comp}%</span>` : ''}<div class="timeline-date">${formatDate(phase.date)}</div>${isCurrent ? '<div style="font-size:0.7em;color:#f9a825;margin-top:4px;">üëà ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>' : ''}</div></div>`;
  }).join('')}</div>`;
  
  $('progressContent').innerHTML = html;
  if (plot.growthLogs && plot.growthLogs.length >= 2) setTimeout(() => renderChart(plot), 100);
}

function renderChart(plot) {
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  const ctx = document.getElementById('growthChart')?.getContext('2d');
  if (!ctx) return;
  
  const logs = [...plot.growthLogs].sort((a, b) => a.day - b.day);
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: logs.map(l => `‡∏ß‡∏±‡∏ô ${l.day}`),
      datasets: [
        { label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', data: logs.map(l => l.height), borderColor: '#4caf50', backgroundColor: 'rgba(76,175,80,0.1)', tension: 0.3, fill: true, yAxisID: 'y' },
        { label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö', data: logs.map(l => l.leaves), borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.1)', tension: 0.3, fill: true, yAxisID: 'y1' }
      ]
    },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { position: 'left', title: { display: true, text: '‡∏ã‡∏°.' } }, y1: { position: 'right', title: { display: true, text: '‡πÉ‡∏ö' }, grid: { drawOnChartArea: false } } } }
  });
}

function renderRecord() {
  const plot = getCurrentPlot();
  if (!plot) { $('recordContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p></div>`; return; }
  
  const dayNum = getDaysDiff(today, plot.startDate) + 1;
  let html = `<div class="card"><h2>üìè ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å - ${plot.name}</h2><p style="font-size:0.75em;color:#888;margin-bottom:10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayNum}</p><div class="form-row"><div class="form-group"><label>üìè ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input type="number" id="newHeight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" min="0" max="500"></div><div class="form-group"><label>üçÉ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö</label><input type="number" id="newLeaves" placeholder="‡πÄ‡∏ä‡πà‡∏ô 4" min="0" max="1000"></div></div><div class="form-group"><label>‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label><input type="text" id="problemLog" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏û‡∏ö‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢"></div><button class="btn" onclick="addGrowthLog('${plot.id}')">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button></div>`;
  
  const logs = plot.growthLogs || [];
  html += `<div class="card"><h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (${logs.length})</h2>${logs.length === 0 ? '<p style="text-align:center;color:#999;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</p>' : logs.slice().reverse().map(log => `<div class="growth-item"><button class="delete-btn" onclick="deleteGrowthLog('${plot.id}', '${log.id}')" title="‡∏•‡∏ö">√ó</button><div class="growth-header"><span class="growth-day">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${log.day}</span><span class="growth-date">${formatDate(log.date)}</span></div><div class="growth-tags">${log.height ? `<span class="growth-tag height">üìè ${log.height} ‡∏ã‡∏°.</span>` : ''}${log.leaves ? `<span class="growth-tag leaves">üçÉ ${log.leaves} ‡πÉ‡∏ö</span>` : ''}${log.problem ? `<span class="growth-tag problem">‚ö†Ô∏è ${log.problem}</span>` : ''}</div></div>`).join('')}</div>`;
  
  const logEntries = Object.entries(plot.dailyLogs || {}).slice().reverse().slice(0, 7);
  html += `<div class="card"><h2>üìã ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° 7 ‡∏ß‡∏±‡∏ô</h2>${logEntries.length === 0 ? '<p style="text-align:center;color:#999;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</p>' : logEntries.map(([date, logs]) => `<div style="background:#f5f5f5;padding:8px;border-radius:8px;margin-bottom:6px;"><div style="font-size:0.75em;font-weight:600;color:#555;margin-bottom:4px;">${new Date(date).toLocaleDateString('th-TH', { weekday: 'short', day: 'numeric', month: 'short' })}</div><div style="display:flex;flex-wrap:wrap;gap:4px;">${logs.water_am ? `<span style="padding:2px 6px;border-radius:6px;font-size:0.6em;background:#e3f2fd;color:#1565c0;">üíß‡πÄ‡∏ä‡πâ‡∏≤</span>` : ''}${logs.water_pm ? `<span style="padding:2px 6px;border-radius:6px;font-size:0.6em;background:#e3f2fd;color:#1565c0;">üíß‡πÄ‡∏¢‡πá‡∏ô</span>` : ''}${logs.em ? `<span style="padding:2px 6px;border-radius:6px;font-size:0.6em;background:#fff3e0;color:#e65100;">ü¶†EM</span>` : ''}${logs.tricho ? `<span style="padding:2px 6px;border-radius:6px;font-size:0.6em;background:#e8f5e9;color:#2e7d32;">üçÑ‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ</span>` : ''}${logs.check ? `<span style="padding:2px 6px;border-radius:6px;font-size:0.6em;background:#fffde7;color:#f9a825;">üîç‡∏ï‡∏£‡∏ß‡∏à</span>` : ''}${logs.photo ? `<span style="padding:2px 6px;border-radius:6px;font-size:0.6em;background:#f3e5f5;color:#7b1fa2;">üì∏</span>` : ''}</div></div>`).join('')}</div>`;
  
  $('recordContent').innerHTML = html;
}

function renderGuide() {
  let html = `<div class="card"><h2>üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>${Object.entries(bioProducts).map(([key, bio]) => `<div class="bio-accordion bio-${bio.color}" onclick="this.classList.toggle('open')" style="border-color:currentColor;"><div class="bio-accordion-header"><div class="info"><span class="icon">${bio.icon}</span><div><div class="name">${bio.name}</div><div class="fullname">${bio.fullName}</div></div></div><span class="arrow">‚ñº</span></div><div class="bio-accordion-body" onclick="event.stopPropagation()"><div class="bio-info-box"><b>üìè ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô:</b> ${bio.ratio}</div><div class="bio-info-box"><b>‚è∞ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà:</b> ${bio.when}</div><div class="bio-info-box"><b>üìù ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</b> ${bio.how}</div><div class="bio-info-box"><b>‚úÖ ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:</b><ul>${bio.benefits.map(b => `<li>${b}</li>`).join('')}</ul></div><div class="bio-info-box"><b>üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö:</b> ${bio.tips}</div><div class="bio-info-box"><b>üì¶ ‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡πá‡∏ö:</b> ${bio.storage}</div></div></div>`).join('')}</div>`;
  
  html += `<div class="warning-box"><h3>‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á</h3><ul><li><span>‚ùå</span> ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏£‡πÄ‡∏Ñ‡∏°‡∏µ‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡∏£‡∏≤</li><li><span>‚ùå</span> ‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ + ‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢ ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ô</li><li><span>‚úÖ</span> ‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢ + ‡πÄ‡∏°‡∏ï‡∏≤‡πÑ‡∏£‡πÄ‡∏ã‡∏µ‡∏¢‡∏° ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ</li><li><span>üåÖ</span> ‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πâ‡∏≤‡∏ï‡∏£‡∏π‡πà</li><li><span>‚ùÑÔ∏è</span> ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏¢‡πá‡∏ô ‡∏≠‡∏≤‡∏¢‡∏∏ 3-6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</li><li><span>‚è∏Ô∏è</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏µ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö 3-5 ‡∏ß‡∏±‡∏ô</li></ul></div>`;
  
  html += `<div class="schedule-table"><h3>üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ</h3><div class="schedule-row"><span class="time">‡∏Å‡πà‡∏≠‡∏ô‡∏õ‡∏•‡∏π‡∏Å 7 ‡∏ß‡∏±‡∏ô</span><span class="action">EM + ‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ</span></div><div class="schedule-row"><span class="time">‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å</span><span class="action">‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ</span></div><div class="schedule-row"><span class="time">‡∏ó‡∏∏‡∏Å 5-7 ‡∏ß‡∏±‡∏ô</span><span class="action">EM + ‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ</span></div><div class="schedule-row"><span class="time">‡∏ó‡∏∏‡∏Å 7-10 ‡∏ß‡∏±‡∏ô</span><span class="action">‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô</span></div><div class="schedule-row"><span class="time">‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á</span><span class="action">‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢/‡πÄ‡∏°‡∏ï‡∏≤</span></div><div class="schedule-row"><span class="time">‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö 3-5 ‡∏ß‡∏±‡∏ô</span><span class="action" style="color:#c62828;">‡∏´‡∏¢‡∏∏‡∏î‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á</span></div></div>`;
  
  $('guideContent').innerHTML = html;
}

// ==================== PDF Export ====================
async function exportPDF(plotId) {
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let y = 20;
  
  const addText = (text, size = 12) => { if (y > 280) { doc.addPage(); y = 20; } doc.setFontSize(size); doc.text(text, 20, y); y += 8; };
  
  addText(`Organic Vegetable Report`, 18);
  addText(`Plot: ${plot.name}`, 14);
  addText(`Vegetable: ${plot.veggie.name}`, 12);
  addText(`Start: ${formatDate(plot.startDate)}`, 12);
  addText(`Harvest: ${formatDate(addDays(new Date(plot.startDate), plot.veggie.days))}`, 12);
  y += 4;
  
  const pct = Math.min(100, Math.max(0, Math.round((getDaysDiff(today, addDays(new Date(plot.startDate), -7)) / (plot.veggie.days + 7)) * 100)));
  const tasksDone = Object.values(plot.completedTasks || {}).filter(Boolean).length;
  addText(`Progress: ${pct}%`, 14);
  addText(`Tasks Done: ${tasksDone}`, 12);
  y += 4;
  
  const logs = plot.growthLogs || [];
  if (logs.length) {
    addText(`Growth Records (${logs.length})`, 14);
    logs.forEach(log => {
      let t = `Day ${log.day}: `;
      if (log.height) t += `H:${log.height}cm `;
      if (log.leaves) t += `L:${log.leaves} `;
      if (log.problem) t += `[${log.problem}]`;
      addText(t, 10);
    });
    y += 4;
  }
  
  addText(`Timeline`, 14);
  plot.phases.forEach((p, i) => { addText(`${i + 1}. ${p.name} - ${formatDate(p.date)} (${getPhaseCompletion(plot, p)}%)`, 10); });
  
  doc.setFontSize(8);
  doc.text(`Generated: ${new Date().toLocaleString('th-TH')}`, 20, 285);
  doc.save(`${plot.name}-report.pdf`);
}

// ==================== Init ====================
document.addEventListener('DOMContentLoaded', () => {
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    updateSyncBadge('syncing', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
    loadFromFirebase();
  } catch (e) {
    updateSyncBadge('error', '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    console.error(e);
  }
  renderGuide();
});

$('modal')?.addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });
</script>
</body>
</html>
