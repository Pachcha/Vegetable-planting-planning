<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏±‡∏Å‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå + ‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÇ‡∏õ‡∏ô‡∏¥‡∏Å‡∏™‡πå</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-app-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/9.23.0/firebase-database-compat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:system-ui,sans-serif;background:linear-gradient(135deg,#e8f5e9,#e3f2fd);min-height:100vh;padding:8px;padding-bottom:70px}
    .container{max-width:650px;margin:0 auto}
    h1{text-align:center;color:#2e7d32;font-size:1.3em;margin-bottom:2px}
    .subtitle{text-align:center;color:#43a047;font-size:0.7em;margin-bottom:10px}
    .card{background:#fff;border-radius:16px;padding:14px;margin-bottom:10px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}
    .card h2{color:#2e7d32;font-size:1em;margin-bottom:10px}
    .card.hydro{border-left:4px solid #2196f3}
    .card.hydro h2{color:#1565c0}
    .form-row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .form-row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .form-group{margin-bottom:10px}
    .form-group label{display:block;font-size:0.75em;color:#555;margin-bottom:4px;font-weight:600}
    select,input[type="date"],input[type="number"],input[type="text"]{width:100%;padding:10px;border:2px solid #c8e6c9;border-radius:10px;font-size:14px;outline:none}
    .hydro-input{border-color:#90caf9}
    input:focus,select:focus{border-color:#4caf50}
    .btn{background:linear-gradient(135deg,#66bb6a,#43a047);color:#fff;border:none;padding:12px;border-radius:12px;font-size:0.85em;font-weight:700;cursor:pointer;width:100%}
    .btn:hover{opacity:0.9}
    .btn-sm{padding:8px 12px;font-size:0.75em;width:auto}
    .btn-danger{background:linear-gradient(135deg,#ef5350,#c62828)}
    .btn-blue{background:linear-gradient(135deg,#42a5f5,#1976d2)}
    .btn-row{display:flex;gap:8px;flex-wrap:wrap}
    .hidden{display:none!important}
    .bottom-nav{position:fixed;bottom:0;left:0;right:0;background:#fff;display:flex;justify-content:space-around;padding:8px;box-shadow:0 -2px 10px rgba(0,0,0,0.1);z-index:100}
    .nav-btn{display:flex;flex-direction:column;align-items:center;gap:2px;padding:6px 12px;border:none;background:0 0;cursor:pointer;color:#888;font-size:0.65em;border-radius:12px}
    .nav-btn .icon{font-size:1.4em}
    .nav-btn.active{color:#4caf50;background:#e8f5e9}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .plot-selector{display:flex;gap:8px;margin-bottom:10px;overflow-x:auto;padding-bottom:4px}
    .plot-btn{padding:8px 14px;background:#f5f5f5;border:2px solid transparent;border-radius:12px;cursor:pointer;font-size:0.8em;white-space:nowrap;display:flex;align-items:center;gap:6px;flex-shrink:0}
    .plot-btn.active{background:#4caf50;color:#fff}
    .plot-btn.hydro.active{background:#1976d2}
    .add-plot-btn{background:#e3f2fd;color:#1976d2;border:2px dashed #90caf9}
    .plot-card{border-radius:16px;padding:14px;color:#fff;margin-bottom:10px}
    .plot-card.organic{background:linear-gradient(135deg,#4caf50,#2e7d32)}
    .plot-card.hydro{background:linear-gradient(135deg,#2196f3,#1565c0)}
    .plot-card .header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .plot-card .icon{font-size:2em}
    .plot-card .title{font-size:1.1em;font-weight:700}
    .plot-card .dates{font-size:0.75em;opacity:0.9}
    .plot-card .progress{background:rgba(255,255,255,0.2);border-radius:10px;padding:8px;margin-top:8px}
    .plot-card .bar{height:10px;background:rgba(255,255,255,0.3);border-radius:5px;overflow:hidden}
    .plot-card .fill{height:100%;background:#fff}
    .plot-card .text{display:flex;justify-content:space-between;font-size:0.7em;margin-top:4px}
    .type-selector{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:15px}
    .type-btn{padding:20px 15px;border:3px solid #e0e0e0;border-radius:16px;cursor:pointer;text-align:center;background:#fff;transition:all 0.2s}
    .type-btn.active{border-color:#4caf50;background:#e8f5e9}
    .type-btn.hydro.active{border-color:#2196f3;background:#e3f2fd}
    .type-btn .icon{font-size:2em;margin-bottom:5px}
    .type-btn .name{font-weight:700;font-size:0.9em}
    .type-btn .desc{font-size:0.7em;color:#888;margin-top:4px}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;text-align:center}
    .stat-box{background:#f5f5f5;padding:10px 6px;border-radius:12px}
    .stat-box.green{background:#e8f5e9}
    .stat-box.blue{background:#e3f2fd}
    .stat-box.purple{background:#f3e5f5}
    .stat-box.orange{background:#fff3e0}
    .stat-value{font-size:1.4em;font-weight:700;color:#333}
    .stat-label{font-size:0.55em;color:#888}
    .hydro-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:10px}
    .hydro-stat{background:#e3f2fd;padding:12px;border-radius:12px;text-align:center}
    .hydro-stat .value{font-size:1.5em;font-weight:700;color:#1565c0}
    .hydro-stat .label{font-size:0.7em;color:#1976d2}
    .hydro-stat .status{font-size:0.65em;padding:2px 8px;border-radius:10px;margin-top:4px;display:inline-block}
    .hydro-stat .status.good{background:#c8e6c9;color:#2e7d32}
    .hydro-stat .status.warn{background:#fff3e0;color:#e65100}
    .hydro-stat .status.bad{background:#ffcdd2;color:#c62828}
    .quick-btns{display:grid;grid-template-columns:repeat(3,1fr);gap:6px}
    .quick-btn{padding:12px 6px;border:none;border-radius:12px;cursor:pointer;background:#f0f0f0;display:flex;flex-direction:column;align-items:center;gap:4px}
    .quick-btn.done{background:#4caf50;color:#fff}
    .quick-btn.hydro.done{background:#1976d2}
    .quick-btn .icon{font-size:1.3em}
    .quick-btn .label{font-size:0.65em;font-weight:600}
    .quick-btn .time{font-size:0.55em;opacity:0.8}
    .checklist{list-style:none}
    .checklist li{display:flex;align-items:flex-start;gap:10px;padding:8px 10px;margin-bottom:4px;background:#f5f5f5;border-radius:10px;cursor:pointer;font-size:0.8em}
    .checklist li.done{background:#c8e6c9}
    .checklist li.done span{text-decoration:line-through;color:#888}
    .checklist input[type="checkbox"]{width:20px;height:20px;accent-color:#4caf50}
    .progress-wrap{background:#e0e0e0;border-radius:10px;height:8px;margin-top:8px;overflow:hidden}
    .progress-bar{height:100%;background:linear-gradient(90deg,#81c784,#4caf50)}
    .progress-bar.hydro{background:linear-gradient(90deg,#64b5f6,#1976d2)}
    .progress-text{display:flex;justify-content:space-between;font-size:0.7em;color:#666;margin-top:4px}
    .phase-card{border-left:4px solid #4caf50}
    .phase-card.hydro{border-left-color:#2196f3}
    .phase-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .phase-title{font-weight:700;color:#2e7d32;font-size:0.95em}
    .phase-card.hydro .phase-title{color:#1565c0}
    .phase-badge{background:#4caf50;color:#fff;padding:3px 10px;border-radius:12px;font-size:0.65em}
    .phase-badge.hydro{background:#1976d2}
    .phase-desc{color:#666;font-size:0.8em;margin-bottom:10px}
    .bio-tags{display:flex;flex-wrap:wrap;gap:4px;margin-bottom:10px}
    .bio-tag{padding:4px 10px;border-radius:12px;font-size:0.7em;border:1px solid}
    .bio-em{background:#fff3e0;color:#e65100;border-color:#ffcc80}
    .bio-tricho{background:#e8f5e9;color:#2e7d32;border-color:#a5d6a7}
    .bio-beau{background:#fce4ec;color:#c2185b;border-color:#f8bbd9}
    .bio-meta{background:#e3f2fd;color:#1565c0;border-color:#90caf9}
    .bio-hormone{background:#f3e5f5;color:#7b1fa2;border-color:#ce93d8}
    .bio-nutrient{background:#e3f2fd;color:#1565c0;border-color:#90caf9}
    .growth-item{background:#f5f5f5;padding:10px;border-radius:10px;margin-bottom:6px;position:relative}
    .growth-header{display:flex;justify-content:space-between;margin-bottom:4px;padding-right:30px}
    .growth-day{font-weight:700;color:#2e7d32;font-size:0.85em}
    .growth-date{font-size:0.65em;color:#999}
    .growth-tags{display:flex;flex-wrap:wrap;gap:4px}
    .growth-tag{padding:3px 8px;border-radius:8px;font-size:0.7em}
    .growth-tag.height{background:#e3f2fd;color:#1565c0}
    .growth-tag.leaves{background:#e8f5e9;color:#2e7d32}
    .growth-tag.ec{background:#fff3e0;color:#e65100}
    .growth-tag.ph{background:#f3e5f5;color:#7b1fa2}
    .growth-tag.problem{background:#ffebee;color:#c62828}
    .delete-btn{position:absolute;top:8px;right:8px;background:#ef5350;color:#fff;border:none;border-radius:50%;width:24px;height:24px;cursor:pointer;font-size:0.9em}
    .timeline-item{display:flex;gap:10px;margin-bottom:8px}
    .timeline-dot{width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.7em;font-weight:700;flex-shrink:0}
    .timeline-dot.done{background:#4caf50;color:#fff}
    .timeline-dot.current{background:#ffd54f;color:#333}
    .timeline-dot.future{background:#e0e0e0;color:#999}
    .timeline-content{flex:1;padding:10px;border-radius:10px;font-size:0.8em}
    .timeline-content.done{background:#e8f5e9}
    .timeline-content.current{background:#fffde7;border:2px solid #ffd54f}
    .timeline-content.future{background:#f5f5f5}
    .timeline-title{font-weight:600}
    .timeline-date{font-size:0.85em;color:#888}
    .timeline-percent{float:right;padding:2px 8px;border-radius:10px;font-size:0.8em}
    .timeline-percent.complete{background:#4caf50;color:#fff}
    .timeline-percent.partial{background:#ffe082}
    .chart-container{position:relative;height:220px;margin:10px 0}
    .system-badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:0.7em;background:#e3f2fd;color:#1565c0;margin-left:8px}
    .nutrient-guide{background:#e3f2fd;border-radius:12px;padding:12px;margin-top:10px}
    .nutrient-guide h3{color:#1565c0;font-size:0.85em;margin-bottom:8px}
    .nutrient-row{display:flex;justify-content:space-between;padding:8px;background:#fff;border-radius:8px;margin-bottom:4px;font-size:0.75em}
    .bio-accordion{border:2px solid;border-radius:12px;margin-bottom:8px;overflow:hidden}
    .bio-accordion-header{padding:12px;display:flex;align-items:center;justify-content:space-between;cursor:pointer}
    .bio-accordion-header .info{display:flex;align-items:center;gap:8px}
    .bio-accordion-header .icon{font-size:1.5em}
    .bio-accordion-header .name{font-weight:700;font-size:0.9em}
    .bio-accordion-header .fullname{font-size:0.65em;opacity:0.7}
    .bio-accordion-header .arrow{transition:transform 0.3s}
    .bio-accordion.open .arrow{transform:rotate(180deg)}
    .bio-accordion-body{padding:0 12px 12px;display:none}
    .bio-accordion.open .bio-accordion-body{display:block}
    .bio-info-box{background:rgba(255,255,255,0.5);padding:8px;border-radius:8px;margin-bottom:6px;font-size:0.75em}
    .bio-info-box b{display:block;margin-bottom:2px}
    .bio-info-box ul{margin:0;padding-left:16px}
    .warning-box{background:#ffebee;border:2px solid #ef9a9a;border-radius:12px;padding:12px;margin-bottom:10px}
    .warning-box h3{color:#c62828;font-size:0.85em;margin-bottom:8px}
    .warning-box ul{list-style:none;font-size:0.75em}
    .warning-box li{display:flex;gap:6px;margin-bottom:6px}
    .tip-box{background:#e3f2fd;border:2px solid #90caf9;border-radius:12px;padding:12px;margin-bottom:10px}
    .tip-box h3{color:#1565c0;font-size:0.85em;margin-bottom:8px}
    .tip-box ul{list-style:none;font-size:0.75em}
    .tip-box li{display:flex;gap:6px;margin-bottom:6px}
    .empty-state{text-align:center;padding:40px 20px}
    .empty-state .icon{font-size:3em;margin-bottom:10px}
    .empty-state p{color:#888;margin-bottom:10px}
    .modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:20px}
    .modal-content{background:#fff;border-radius:16px;padding:20px;max-width:400px;width:100%;max-height:80vh;overflow-y:auto}
    .modal-content h2{color:#2e7d32;margin-bottom:15px}
    .tabs{display:flex;gap:4px;margin-bottom:15px}
    .tab-btn{flex:1;padding:10px;border:none;background:#f5f5f5;border-radius:10px;cursor:pointer;font-size:0.8em;font-weight:600}
    .tab-btn.active{background:#4caf50;color:#fff}
    .tab-btn.hydro.active{background:#1976d2}
  </style>
</head>
<body>
  <div class="container">
    <h1>üå± ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å‡∏ú‡∏±‡∏Å</h1>
    <p class="subtitle">‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå + ‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÇ‡∏õ‡∏ô‡∏¥‡∏Å‡∏™‡πå | <span id="syncBadge" style="background:#fff3e0;color:#e65100;padding:2px 8px;border-radius:10px;font-size:0.9em;">üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span></p>
    
    <div id="mainApp">
      <div id="planner" class="tab-content active">
        <div id="plotSelector" class="plot-selector"></div>
        <div id="plannerContent"></div>
      </div>
      <div id="today" class="tab-content"><div id="todayContent"></div></div>
      <div id="progress" class="tab-content"><div id="progressContent"></div></div>
      <div id="record" class="tab-content"><div id="recordContent"></div></div>
      <div id="guide" class="tab-content"><div id="guideContent"></div></div>
    </div>
  </div>
  
  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="showTab('planner')"><span class="icon">ü™¥</span><span>‡πÅ‡∏õ‡∏•‡∏á</span></button>
    <button class="nav-btn" onclick="showTab('today')"><span class="icon">üìÖ</span><span>‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span></button>
    <button class="nav-btn" onclick="showTab('progress')"><span class="icon">üìä</span><span>‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥</span></button>
    <button class="nav-btn" onclick="showTab('record')"><span class="icon">üìù</span><span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span></button>
    <button class="nav-btn" onclick="showTab('guide')"><span class="icon">üìñ</span><span>‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</span></button>
  </nav>
  
  <div id="modal" class="modal hidden"><div class="modal-content" id="modalContent"></div></div>

<script>
// ==================== Firebase Config ====================
const firebaseConfig = {
  apiKey: "AIzaSyDVnLYb27BPs_RM-YY6ASBgkYAiKSPMULM",
  authDomain: "organic-vegetable-planting.firebaseapp.com",
  databaseURL: "https://organic-vegetable-planting-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "organic-vegetable-planting",
  storageBucket: "organic-vegetable-planting.firebasestorage.app",
  messagingSenderId: "384351483160",
  appId: "1:384351483160:web:008a9797fcd2e9f7819a6d"
};
let db = null;

// ==================== Data ====================
const saladVeggies = {
  greenoak: { name: '‡∏Å‡∏£‡∏µ‡∏ô‡πÇ‡∏≠‡πä‡∏Ñ', icon: 'ü•¨', days: 45, germDays: 3, hydroDays: 35, desc: '‡πÉ‡∏ö‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏≠‡πà‡∏≠‡∏ô ‡∏£‡∏™‡∏Å‡∏£‡∏≠‡∏ö', tips: '‡∏ä‡∏≠‡∏ö‡πÅ‡∏î‡∏î‡∏£‡∏≥‡πÑ‡∏£', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '4-6 ‡∏ä‡∏°.' },
  redoak: { name: '‡πÄ‡∏£‡∏î‡πÇ‡∏≠‡πä‡∏Ñ', icon: 'ü•ó', days: 45, germDays: 3, hydroDays: 35, desc: '‡πÉ‡∏ö‡∏™‡∏µ‡πÅ‡∏î‡∏á ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á', tips: '‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏™‡∏ß‡∏¢', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '5-6 ‡∏ä‡∏°.' },
  butterhead: { name: '‡∏ö‡∏±‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÄ‡∏Æ‡∏î', icon: 'ü•¨', days: 50, germDays: 4, hydroDays: 40, desc: '‡πÉ‡∏ö‡∏ô‡∏∏‡πà‡∏° ‡∏£‡∏™‡∏´‡∏ß‡∏≤‡∏ô‡∏°‡∏±‡∏ô', tips: '‡∏ä‡∏≠‡∏ö‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏¢‡πá‡∏ô', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '4-5 ‡∏ä‡∏°.' },
  cos: { name: '‡∏Å‡∏£‡∏µ‡∏ô‡∏Ñ‡∏≠‡∏™', icon: 'ü•ó', days: 55, germDays: 4, hydroDays: 42, desc: '‡πÉ‡∏ö‡∏¢‡∏≤‡∏ß‡∏Å‡∏£‡∏≠‡∏ö ‡∏ó‡∏≥‡∏™‡∏•‡∏±‡∏î', tips: '‡∏ó‡∏ô‡πÅ‡∏î‡∏î ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏≤‡∏Å', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '5-7 ‡∏ä‡∏°.' },
  filley: { name: '‡∏ü‡∏¥‡∏•‡πÄ‡∏•‡∏¢‡πå', icon: 'üåø', days: 40, germDays: 3, hydroDays: 30, desc: '‡πÉ‡∏ö‡∏´‡∏¢‡∏±‡∏Å ‡πÇ‡∏ï‡πÄ‡∏£‡πá‡∏ß', tips: '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '4-5 ‡∏ä‡∏°.' }
};

const thaiVeggies = {
  kana: { name: '‡∏Ñ‡∏∞‡∏ô‡πâ‡∏≤', icon: 'ü•¨', days: 50, germDays: 4, hydroDays: 40, desc: '‡∏ú‡∏±‡∏Å‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏° ‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô‡∏™‡∏π‡∏á', tips: '‡∏õ‡∏•‡∏π‡∏Å‡πÑ‡∏î‡πâ‡∏ï‡∏•‡∏≠‡∏î‡∏õ‡∏µ', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '5-6 ‡∏ä‡∏°.' },
  pakbung: { name: '‡∏ú‡∏±‡∏Å‡∏ö‡∏∏‡πâ‡∏á‡∏à‡∏µ‡∏ô', icon: 'üåø', days: 25, germDays: 3, hydroDays: 20, desc: '‡πÇ‡∏ï‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å ‡∏õ‡∏•‡∏π‡∏Å‡∏á‡πà‡∏≤‡∏¢', tips: '‡πÅ‡∏ä‡πà‡πÄ‡∏°‡∏•‡πá‡∏î 12 ‡∏ä‡∏°.', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2-3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '5-6 ‡∏ä‡∏°.' },
  pakchoi: { name: '‡∏ú‡∏±‡∏Å‡∏Å‡∏ß‡∏≤‡∏á‡∏ï‡∏∏‡πâ‡∏á', icon: 'ü•¨', days: 35, germDays: 3, hydroDays: 28, desc: '‡∏≠‡∏≤‡∏¢‡∏∏‡∏™‡∏±‡πâ‡∏ô ‡πÇ‡∏ï‡πÑ‡∏ß', tips: '‡∏ä‡∏≠‡∏ö‡πÅ‡∏î‡∏î ‡∏ô‡πâ‡∏≥‡∏™‡∏°‡πà‡∏≥‡πÄ‡∏™‡∏°‡∏≠', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '5-6 ‡∏ä‡∏°.' },
  pakchi: { name: '‡∏ú‡∏±‡∏Å‡∏ä‡∏µ', icon: 'üå±', days: 45, germDays: 7, hydroDays: 35, desc: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∏‡∏á‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°', tips: '‡∏ö‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏û‡∏≤‡∏∞', water: '‡∏ß‡∏±‡∏ô‡∏•‡∏∞ 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á', light: '3-4 ‡∏ä‡∏°.' }
};

const hydroSystems = {
  nft: { name: 'NFT', fullName: 'Nutrient Film Technique', icon: 'üåä', desc: '‡∏ô‡πâ‡∏≥‡πÑ‡∏´‡∏•‡πÄ‡∏õ‡πá‡∏ô‡∏ü‡∏¥‡∏•‡πå‡∏°‡∏ö‡∏≤‡∏á', pros: ['‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥', '‡∏£‡∏≤‡∏Å‡πÑ‡∏î‡πâ‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô', '‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏ú‡∏±‡∏Å‡πÉ‡∏ö'], cons: ['‡πÑ‡∏ü‡∏î‡∏±‡∏ö=‡∏ï‡∏≤‡∏¢', '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏õ‡∏±‡πä‡∏°'] },
  dwc: { name: 'DWC', fullName: 'Deep Water Culture', icon: 'ü´ß', desc: '‡∏£‡∏≤‡∏Å‡∏à‡∏°‡∏ô‡πâ‡∏≥ + ‡∏õ‡∏±‡πä‡∏°‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', pros: ['‡∏ï‡πâ‡∏ô‡πÇ‡∏ï‡πÑ‡∏ß', '‡∏î‡∏π‡πÅ‡∏•‡∏á‡πà‡∏≤‡∏¢', '‡∏ú‡∏±‡∏Å‡πÉ‡∏ö/‡∏ú‡∏•‡πÑ‡∏°‡πâ'], cons: ['‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡∏≠‡∏∞', '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡πâ‡∏≥'] },
  kratky: { name: 'Kratky', fullName: 'Kratky Method', icon: 'ü™£', desc: '‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡∏õ‡∏±‡πä‡∏° ‡∏ô‡πâ‡∏≥‡∏ô‡∏¥‡πà‡∏á', pros: ['‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏ü', '‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ñ‡∏π‡∏Å', '‡∏á‡πà‡∏≤‡∏¢‡∏°‡∏≤‡∏Å'], cons: ['‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥', '‡∏ú‡∏±‡∏Å‡πÄ‡∏•‡πá‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô'] },
  drip: { name: 'Drip', fullName: 'Drip System', icon: 'üíß', desc: '‡∏´‡∏¢‡∏î‡∏ô‡πâ‡∏≥‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏ô‡∏ï‡πâ‡∏ô', pros: ['‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥', '‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ', '‡∏ó‡∏∏‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î'], cons: ['‡∏ó‡πà‡∏≠‡∏≠‡∏∏‡∏î‡∏ï‡∏±‡∏ô', '‡∏ã‡∏±‡∏ö‡∏ã‡πâ‡∏≠‡∏ô'] }
};

const bioProducts = {
  em: { name: 'EM ‡∏à‡∏∏‡∏•‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå', icon: 'ü¶†', color: 'em', fullName: 'Effective Microorganisms', ratio: '1:10 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏ó‡∏∏‡∏Å 5-7 ‡∏ß‡∏±‡∏ô', benefits: ['‡∏õ‡∏£‡∏±‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏î‡∏¥‡∏ô', '‡∏¢‡πà‡∏≠‡∏¢‡∏™‡∏•‡∏≤‡∏¢‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏', '‡∏ä‡πà‡∏ß‡∏¢‡∏î‡∏π‡∏î‡∏ã‡∏∂‡∏°‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£'] },
  tricho: { name: '‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏≤', icon: 'üçÑ', color: 'tricho', fullName: 'Trichoderma', ratio: '25g:20 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏ó‡∏∏‡∏Å 5-7 ‡∏ß‡∏±‡∏ô', benefits: ['‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏£‡∏≤‡∏Å‡πÄ‡∏ô‡πà‡∏≤', '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡πà‡∏≤‡∏Ñ‡∏≠‡∏î‡∏¥‡∏ô', '‡∏Å‡∏£‡∏∞‡∏ï‡∏∏‡πâ‡∏ô‡∏†‡∏π‡∏°‡∏¥‡∏Ñ‡∏∏‡πâ‡∏°‡∏Å‡∏±‡∏ô'] },
  beauveria: { name: '‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢', icon: 'ü¶ü', color: 'beau', fullName: 'Beauveria bassiana', ratio: '50g:20 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á', benefits: ['‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÄ‡∏û‡∏•‡∏µ‡πâ‡∏¢‡∏≠‡πà‡∏≠‡∏ô', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÅ‡∏°‡∏•‡∏á‡∏´‡∏ß‡∏µ‡πà‡∏Ç‡∏≤‡∏ß'] },
  metarhizium: { name: '‡πÄ‡∏°‡∏ï‡∏≤‡πÑ‡∏£‡πÄ‡∏ã‡∏µ‡∏¢‡∏°', icon: 'ü™≤', color: 'meta', fullName: 'Metarhizium', ratio: '50g:20 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏û‡∏ö‡πÅ‡∏°‡∏•‡∏á', benefits: ['‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏î‡πâ‡∏ß‡∏á‡∏´‡∏°‡∏±‡∏î‡∏ú‡∏±‡∏Å', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡πÑ‡∏£‡πÅ‡∏î‡∏á'] },
  hormone: { name: '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡∏û‡∏∑‡∏ä', icon: 'üåø', color: 'hormone', fullName: '‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô‡∏ú‡∏•‡πÑ‡∏°‡πâ', ratio: '4-5 ‡∏ä‡πâ‡∏≠‡∏ô:10 ‡∏•‡∏¥‡∏ï‡∏£', when: '‡∏ó‡∏∏‡∏Å 7-10 ‡∏ß‡∏±‡∏ô', benefits: ['‡πÄ‡∏£‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', '‡∏ú‡∏±‡∏Å‡∏≠‡∏ß‡∏ö‡∏´‡∏ß‡∏≤‡∏ô‡∏Å‡∏£‡∏≠‡∏ö'] }
};

const hydroNutrients = {
  seedling: { stage: '‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', days: '1-7', ec: '0.8-1.0', ph: '5.8-6.2', ratioA: 2.5, ratioB: 2.5 },
  vegetative: { stage: '‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï', days: '8-21', ec: '1.2-1.6', ph: '5.5-6.0', ratioA: 5, ratioB: 5 },
  mature: { stage: '‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Å‡πá‡∏ö', days: '22+', ec: '1.6-2.0', ph: '5.5-6.0', ratioA: 5, ratioB: 5 }
};

// ==================== State ====================
let plots = [], currentPlotId = null, chartInstance = null, guideTab = 'organic';
const $ = id => document.getElementById(id);
const genId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);
const addDays = (d, n) => { const r = new Date(d); r.setDate(r.getDate() + n); return r; };
const formatDate = d => new Date(d).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' });
const formatDateFull = d => new Date(d).toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
const getDaysDiff = (d1, d2) => Math.floor((new Date(d1) - new Date(d2)) / 86400000);
const today = new Date(); today.setHours(0,0,0,0);
const todayKey = today.toISOString().split('T')[0];

// ==================== Storage (Firebase) ====================
function updateSyncBadge(status, text) {
  const badge = $('syncBadge');
  if (!badge) return;
  const colors = { '': { bg: '#e8f5e9', c: '#2e7d32' }, syncing: { bg: '#fff3e0', c: '#e65100' }, error: { bg: '#ffebee', c: '#c62828' } };
  const col = colors[status] || colors[''];
  badge.style.background = col.bg;
  badge.style.color = col.c;
  badge.innerHTML = text;
}

function saveData() {
  if (!db) return;
  updateSyncBadge('syncing', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
  db.ref('veggie-hydro-v1').set({ plots, currentPlotId })
    .then(() => updateSyncBadge('', '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß'))
    .catch(() => updateSyncBadge('error', '‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'));
}

function loadData() {
  if (!db) return;
  db.ref('veggie-hydro-v1').on('value', snap => {
    const d = snap.val();
    if (d) {
      plots = (d.plots || []).map(p => ({ ...p, completedTasks: p.completedTasks || {}, dailyLogs: p.dailyLogs || {}, growthLogs: p.growthLogs || [] }));
      currentPlotId = d.currentPlotId || (plots[0]?.id || null);
    }
    updateSyncBadge('', '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
    renderAll();
  }, () => updateSyncBadge('error', '‚ùå ‡πÇ‡∏´‡∏•‡∏î‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß'));
}

// ==================== Navigation ====================
function showTab(tabId) {
  document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(t => t.classList.remove('active'));
  $(tabId).classList.add('active');
  document.querySelector(`.nav-btn[onclick="showTab('${tabId}')"]`).classList.add('active');
  renderCurrentTab();
}

function renderCurrentTab() {
  const active = document.querySelector('.tab-content.active');
  if (active?.id === 'planner') renderPlanner();
  if (active?.id === 'today') renderToday();
  if (active?.id === 'progress') renderProgress();
  if (active?.id === 'record') renderRecord();
  if (active?.id === 'guide') renderGuide();
}

function renderAll() { renderPlotSelector(); renderCurrentTab(); }

// ==================== Plot Management ====================
function renderPlotSelector() {
  let html = plots.map(p => `<button class="plot-btn ${p.type === 'hydro' ? 'hydro' : ''} ${p.id === currentPlotId ? 'active' : ''}" onclick="selectPlot('${p.id}')">${p.type === 'hydro' ? 'üíß' : 'üå±'} ${p.name}</button>`).join('');
  html += `<button class="plot-btn add-plot-btn" onclick="showAddPlotModal()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á</button>`;
  $('plotSelector').innerHTML = html;
}

function selectPlot(id) { currentPlotId = id; saveData(); renderAll(); }
function getCurrentPlot() { return plots.find(p => p.id === currentPlotId); }

function showAddPlotModal() {
  $('modalContent').innerHTML = `
    <h2>üå± ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á‡πÉ‡∏´‡∏°‡πà</h2>
    <div class="type-selector">
      <div class="type-btn active" onclick="selectType('organic', this)">
        <div class="icon">üå±</div>
        <div class="name">‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå (‡∏î‡∏¥‡∏ô)</div>
        <div class="desc">‡πÉ‡∏ä‡πâ‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå</div>
      </div>
      <div class="type-btn hydro" onclick="selectType('hydro', this)">
        <div class="icon">üíß</div>
        <div class="name">‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÇ‡∏õ‡∏ô‡∏¥‡∏Å‡∏™‡πå</div>
        <div class="desc">‡∏™‡∏≤‡∏£‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏ò‡∏≤‡∏ï‡∏∏‡∏≠‡∏≤‡∏´‡∏≤‡∏£</div>
      </div>
    </div>
    <input type="hidden" id="plotType" value="organic">
    <div class="form-group"><label>‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á</label><input type="text" id="plotName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏õ‡∏•‡∏á A"></div>
    <div class="form-row">
      <div class="form-group"><label>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏±‡∏Å</label><select id="category" onchange="updateVeggieOpts()"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option><option value="salad">ü•ó ‡∏ú‡∏±‡∏Å‡∏™‡∏•‡∏±‡∏î</option><option value="thai">üåø ‡∏ú‡∏±‡∏Å‡πÑ‡∏ó‡∏¢</option></select></div>
      <div class="form-group"><label>‡∏ä‡∏ô‡∏¥‡∏î</label><select id="veggieType"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option></select></div>
    </div>
    <div id="hydroSystemDiv" class="form-group hidden"><label>üíß ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏Æ‡πÇ‡∏î‡∏£</label><select id="hydroSystem"><option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>${Object.entries(hydroSystems).map(([k,v]) => `<option value="${k}">${v.icon} ${v.name} - ${v.desc}</option>`).join('')}</select></div>
    <div class="form-group"><label>üìÖ ‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°</label><input type="date" id="startDate" value="${todayKey}"></div>
    <div class="btn-row"><button class="btn" onclick="createPlot()">üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏õ‡∏•‡∏á</button><button class="btn btn-danger" onclick="closeModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button></div>`;
  $('modal').classList.remove('hidden');
}

function selectType(type, el) {
  document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
  $('plotType').value = type;
  $('hydroSystemDiv').classList.toggle('hidden', type !== 'hydro');
}

function updateVeggieOpts() {
  const cat = $('category')?.value, sel = $('veggieType');
  if (!sel) return;
  sel.innerHTML = '<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å...</option>';
  const data = cat === 'salad' ? saladVeggies : cat === 'thai' ? thaiVeggies : {};
  Object.entries(data).forEach(([k, v]) => sel.innerHTML += `<option value="${k}">${v.icon} ${v.name}</option>`);
}

function createPlot() {
  const type = $('plotType').value;
  const name = $('plotName').value.trim() || `‡πÅ‡∏õ‡∏•‡∏á ${plots.length + 1}`;
  const cat = $('category').value, veggieKey = $('veggieType').value, startDateStr = $('startDate').value;
  const hydroSys = type === 'hydro' ? $('hydroSystem').value : null;
  
  if (!cat || !veggieKey || !startDateStr) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö'); return; }
  if (type === 'hydro' && !hydroSys) { alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏Æ‡πÇ‡∏î‡∏£'); return; }
  
  const veggie = (cat === 'salad' ? saladVeggies : thaiVeggies)[veggieKey];
  const start = new Date(startDateStr);
  const totalDays = type === 'hydro' ? veggie.hydroDays : veggie.days;
  const phases = type === 'hydro' ? generateHydroPhases(veggie, start) : generateOrganicPhases(veggie, start);
  
  const newPlot = { 
    id: genId(), name, type, veggie: {...veggie, totalDays}, 
    hydroSystem: hydroSys, startDate: start.toISOString(), 
    phases, completedTasks: {}, dailyLogs: {}, growthLogs: [] 
  };
  plots.push(newPlot);
  currentPlotId = newPlot.id;
  saveData(); closeModal(); renderAll();
}

function generateOrganicPhases(veggie, start) {
  return [
    { id: 'prep', day: -7, name: 'üîß ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏î‡∏¥‡∏ô', desc: '‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô ‡∏ú‡∏™‡∏°‡∏õ‡∏∏‡πã‡∏¢ ‡∏£‡∏≤‡∏î EM', bio: ['em', 'tricho'], tasks: ['‡∏û‡∏£‡∏ß‡∏ô‡∏î‡∏¥‡∏ô‡∏£‡πà‡∏ß‡∏ô‡∏ã‡∏∏‡∏¢', '‡∏ú‡∏™‡∏°‡∏î‡∏¥‡∏ô:‡∏õ‡∏∏‡πã‡∏¢:‡∏Ç‡∏∏‡∏¢‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß', '‡∏£‡∏≤‡∏î EM', '‡πÇ‡∏£‡∏¢‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏°‡∏≤', '‡∏Ñ‡∏•‡∏∏‡∏°‡∏ü‡∏≤‡∏á'] },
    { id: 'plant', day: 0, name: 'üå± ‡∏ß‡∏±‡∏ô‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡∏î‡πâ‡∏ß‡∏¢‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', bio: ['tricho'], tasks: ['‡∏Ñ‡∏•‡∏∏‡∏Å‡πÄ‡∏°‡∏•‡πá‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', '‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î', '‡∏Å‡∏•‡∏ö‡∏î‡∏¥‡∏ô‡∏ö‡∏≤‡∏á', '‡∏£‡∏î‡∏ô‡πâ‡∏≥‡∏ä‡∏∏‡πà‡∏°'] },
    { id: 'germ', day: veggie.germDays, name: 'üåø ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏á‡∏≠‡∏Å', desc: '‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤‡πÇ‡∏ú‡∏•‡πà', bio: ['em'], tasks: ['‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', '‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á', '‡∏£‡∏î EM'] },
    { id: 'care1', day: 7, name: 'üíß ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå 1', desc: '‡∏£‡∏î EM ‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', bio: ['em', 'tricho'], tasks: ['‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤-‡πÄ‡∏¢‡πá‡∏ô', '‡∏£‡∏î EM', '‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', '‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏°‡∏•‡∏á'] },
    { id: 'transplant', day: 14, name: 'ü™¥ ‡∏¢‡πâ‡∏≤‡∏¢‡∏õ‡∏•‡∏π‡∏Å', desc: '‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡πÅ‡∏õ‡∏•‡∏á', bio: ['tricho'], tasks: ['‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏•‡∏∏‡∏°', '‡πÉ‡∏™‡πà‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡πâ‡∏ô', '‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', '‡∏£‡∏î‡∏ô‡πâ‡∏≥'] },
    { id: 'care2', day: 21, name: 'üíß ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå 3', desc: 'EM + ‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ ‡∏£‡∏≠‡∏ö 2', bio: ['em', 'tricho', 'hormone'], tasks: ['‡∏£‡∏î EM', '‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ', '‡∏â‡∏µ‡∏î‡∏Æ‡∏≠‡∏£‡πå‡πÇ‡∏°‡∏ô', '‡∏Å‡∏≥‡∏à‡∏±‡∏î‡∏ß‡∏±‡∏ä‡∏û‡∏∑‡∏ä'] },
    { id: 'grow', day: Math.floor(veggie.days * 0.8), name: 'ü•¨ ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Å‡πá‡∏ö', desc: '‡∏ï‡πâ‡∏ô‡πÇ‡∏ï‡πÄ‡∏ï‡πá‡∏°‡∏ó‡∏µ‡πà', bio: [], tasks: ['‡∏ï‡∏£‡∏ß‡∏à‡∏®‡∏±‡∏ï‡∏£‡∏π‡∏û‡∏∑‡∏ä', '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå'] },
    { id: 'harvest', day: veggie.days, name: 'üéâ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß!', desc: '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡∏™‡∏î!', bio: [], tasks: ['‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤', '‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏ô', '‡∏•‡πâ‡∏≤‡∏á‡∏™‡∏∞‡∏≠‡∏≤‡∏î', '‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å'] }
  ].map(p => ({ ...p, date: addDays(start, p.day).toISOString() }));
}

function generateHydroPhases(veggie, start) {
  const days = veggie.hydroDays;
  return [
    { id: 'seed', day: 0, name: 'üå± ‡πÄ‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏•‡πá‡∏î', desc: '‡πÄ‡∏û‡∏≤‡∏∞‡πÉ‡∏ô‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥/‡∏£‡πá‡∏≠‡∏Ñ‡∏ß‡∏π‡∏•', bio: [], tasks: ['‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ü‡∏≠‡∏á‡∏ô‡πâ‡∏≥', '‡πÅ‡∏ä‡πà‡∏ô‡πâ‡∏≥‡πÄ‡∏õ‡∏•‡πà‡∏≤', '‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏°‡∏•‡πá‡∏î', '‡∏Ñ‡∏•‡∏∏‡∏°‡∏°‡∏∑‡∏î 2-3 ‡∏ß‡∏±‡∏ô'], hydro: { ec: '0', ph: '6.0' } },
    { id: 'germ', day: veggie.germDays, name: 'üåø ‡πÄ‡∏°‡∏•‡πá‡∏î‡∏á‡∏≠‡∏Å', desc: '‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á', bio: [], tasks: ['‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏Å‡∏á‡∏≠‡∏Å', '‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏á', '‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£'], hydro: { ec: '0.8-1.0', ph: '5.8-6.2' } },
    { id: 'seedling', day: 7, name: 'ü™¥ ‡∏ï‡πâ‡∏ô‡∏Å‡∏•‡πâ‡∏≤', desc: '‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö', bio: [], tasks: ['‡∏ï‡∏£‡∏ß‡∏à‡∏£‡∏≤‡∏Å 3-5 ‡∏ã‡∏°.', '‡∏¢‡πâ‡∏≤‡∏¢‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö', '‡∏ï‡∏£‡∏ß‡∏à EC/pH', '‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏õ‡∏±‡πä‡∏°'], hydro: { ec: '1.0-1.2', ph: '5.5-6.0' } },
    { id: 'veg1', day: 14, name: 'üå± ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï 1', desc: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≤‡∏£‡∏≠‡∏≤‡∏´‡∏≤‡∏£', bio: [], tasks: ['‡πÄ‡∏û‡∏¥‡πà‡∏° EC', '‡∏ï‡∏£‡∏ß‡∏à‡πÉ‡∏ö', '‡πÄ‡∏ï‡∏¥‡∏°‡∏ô‡πâ‡∏≥', '‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏Å'], hydro: { ec: '1.2-1.4', ph: '5.5-6.0' } },
    { id: 'veg2', day: 21, name: 'ü•¨ ‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï 2', desc: '‡∏ï‡πâ‡∏ô‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á', bio: [], tasks: ['‡∏ï‡∏£‡∏ß‡∏à EC/pH', '‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡πâ‡∏≥', '‡∏ï‡∏±‡∏î‡πÉ‡∏ö‡πÄ‡∏™‡∏µ‡∏¢', '‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ'], hydro: { ec: '1.4-1.6', ph: '5.5-6.0' } },
    { id: 'mature', day: Math.floor(days * 0.85), name: 'üåø ‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Å‡πá‡∏ö', desc: '‡∏•‡∏î EC ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö', bio: [], tasks: ['‡∏•‡∏î EC', '‡∏ï‡∏£‡∏ß‡∏à‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û', '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏Å‡πá‡∏ö'], hydro: { ec: '1.0-1.2', ph: '5.8-6.2' } },
    { id: 'harvest', day: days, name: 'üéâ ‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß!', desc: '‡πÄ‡∏Å‡πá‡∏ö‡∏ú‡∏±‡∏Å‡∏™‡∏î!', bio: [], tasks: ['‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤', '‡∏ï‡∏±‡∏î‡∏ó‡∏µ‡πà‡πÇ‡∏Ñ‡∏ô', '‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏Å', '‡∏ä‡∏±‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏´‡∏ô‡∏±‡∏Å'] }
  ].map(p => ({ ...p, date: addDays(start, p.day).toISOString() }));
}

function closeModal() { $('modal').classList.add('hidden'); }
function deletePlot(id) {
  if (!confirm('‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á‡∏ô‡∏µ‡πâ?')) return;
  plots = plots.filter(p => p.id !== id);
  if (currentPlotId === id) currentPlotId = plots[0]?.id || null;
  saveData(); renderAll();
}

// ==================== Phase & Tasks ====================
function getCurrentPhase(plot) {
  if (!plot) return null;
  return [...plot.phases].sort((a, b) => new Date(b.date) - new Date(a.date)).find(p => new Date(p.date) <= today) || plot.phases[0];
}
function getNextPhase(plot) { return plot?.phases.find(p => new Date(p.date) > today); }
function getPhaseCompletion(plot, phase) {
  if (!plot || !phase || !phase.tasks) return 0;
  const done = phase.tasks.filter((_, i) => plot.completedTasks?.[`${phase.id}-${i}`]).length;
  return Math.round((done / phase.tasks.length) * 100);
}
function toggleTask(plotId, phaseId, taskIdx) {
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  if (!plot.completedTasks) plot.completedTasks = {};
  plot.completedTasks[`${phaseId}-${taskIdx}`] = !plot.completedTasks[`${phaseId}-${taskIdx}`];
  saveData(); renderCurrentTab();
}
function logDaily(plotId, type) {
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  if (!plot.dailyLogs) plot.dailyLogs = {};
  if (!plot.dailyLogs[todayKey]) plot.dailyLogs[todayKey] = {};
  plot.dailyLogs[todayKey][type] = new Date().toLocaleTimeString('th-TH', { hour: '2-digit', minute: '2-digit' });
  saveData(); renderCurrentTab();
}

// ==================== Growth Log ====================
function addGrowthLog(plotId) {
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  
  const h = $('newHeight')?.value.trim(), l = $('newLeaves')?.value.trim();
  const ec = $('newEC')?.value.trim(), ph = $('newPH')?.value.trim();
  const p = $('problemLog')?.value.trim();
  
  if (!h && !l && !ec && !ph) { alert('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á'); return; }
  
  if (!plot.growthLogs) plot.growthLogs = [];
  plot.growthLogs.push({ 
    id: genId(), date: new Date().toISOString(), 
    day: getDaysDiff(today, plot.startDate) + 1, 
    height: h ? parseFloat(h) : null, 
    leaves: l ? parseInt(l) : null,
    ec: ec ? parseFloat(ec) : null,
    ph: ph ? parseFloat(ph) : null,
    problem: p 
  });
  
  if ($('newHeight')) $('newHeight').value = '';
  if ($('newLeaves')) $('newLeaves').value = '';
  if ($('newEC')) $('newEC').value = '';
  if ($('newPH')) $('newPH').value = '';
  if ($('problemLog')) $('problemLog').value = '';
  saveData(); renderCurrentTab();
}

function deleteGrowthLog(plotId, logId) {
  if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  const plot = plots.find(p => p.id === plotId);
  if (!plot) return;
  plot.growthLogs = plot.growthLogs.filter(l => l.id !== logId);
  saveData(); renderCurrentTab();
}

// ==================== Render Functions ====================
function renderPlanner() {
  const plot = getCurrentPlot();
  if (!plot) { $('plannerContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p><p style="font-size:0.8em;color:#666;">‡∏Ñ‡∏•‡∏¥‡∏Å "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏õ‡∏•‡∏á"</p></div>`; return; }
  
  const totalDays = plot.veggie.totalDays || plot.veggie.days;
  const dayNum = getDaysDiff(today, plot.startDate) + 1;
  const daysLeft = Math.max(0, totalDays - dayNum + 1);
  const pct = Math.min(100, Math.max(0, Math.round((dayNum / totalDays) * 100)));
  const isHydro = plot.type === 'hydro';
  
  let html = `<div class="plot-card ${isHydro ? 'hydro' : 'organic'}">
    <div class="header">
      <div class="icon">${plot.veggie.icon}</div>
      <div>
        <div class="title">${plot.name} - ${plot.veggie.name} ${isHydro ? `<span class="system-badge">${hydroSystems[plot.hydroSystem]?.icon} ${hydroSystems[plot.hydroSystem]?.name}</span>` : ''}</div>
        <div class="dates">‡πÄ‡∏£‡∏¥‡πà‡∏° ${formatDate(plot.startDate)} ‚Üí ‡πÄ‡∏Å‡πá‡∏ö ${formatDate(addDays(new Date(plot.startDate), totalDays))}</div>
      </div>
    </div>
    <div class="progress">
      <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
      <div class="text"><span>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayNum} ‚Ä¢ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft} ‡∏ß‡∏±‡∏ô</span><span>${pct}%</span></div>
    </div>
  </div>`;
  
  html += `<div class="card ${isHydro ? 'hydro' : ''}"><h2>${isHydro ? 'üíß' : 'üå±'} ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏±‡∏Å</h2>
    <div style="display:flex;gap:10px;">
      <div style="font-size:2.5em;">${plot.veggie.icon}</div>
      <div style="flex:1;">
        <div style="font-weight:700;color:${isHydro ? '#1565c0' : '#2e7d32'};">${plot.veggie.name}</div>
        <div style="font-size:0.75em;color:#666;margin:4px 0;">${plot.veggie.desc}</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;">
          <div style="background:#f5f5f5;padding:6px 8px;border-radius:8px;font-size:0.7em;">‚è±Ô∏è ${totalDays} ‡∏ß‡∏±‡∏ô</div>
          <div style="background:#f5f5f5;padding:6px 8px;border-radius:8px;font-size:0.7em;">üå± ‡∏á‡∏≠‡∏Å ${plot.veggie.germDays} ‡∏ß‡∏±‡∏ô</div>
          <div style="background:#f5f5f5;padding:6px 8px;border-radius:8px;font-size:0.7em;">‚òÄÔ∏è ${plot.veggie.light}</div>
          <div style="background:#f5f5f5;padding:6px 8px;border-radius:8px;font-size:0.7em;">${isHydro ? 'üíß ‡πÑ‡∏Æ‡πÇ‡∏î‡∏£' : 'üå± ‡∏î‡∏¥‡∏ô'}</div>
        </div>
      </div>
    </div>
  </div>`;
  
  if (isHydro) {
    const sys = hydroSystems[plot.hydroSystem];
    html += `<div class="card hydro"><h2>üíß ‡∏£‡∏∞‡∏ö‡∏ö ${sys.name}</h2>
      <p style="font-size:0.8em;color:#666;margin-bottom:8px;">${sys.fullName} - ${sys.desc}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        ${sys.pros.map(p => `<span style="background:#c8e6c9;color:#2e7d32;padding:4px 8px;border-radius:8px;font-size:0.7em;">‚úì ${p}</span>`).join('')}
        ${sys.cons.map(c => `<span style="background:#ffcdd2;color:#c62828;padding:4px 8px;border-radius:8px;font-size:0.7em;">‚ö† ${c}</span>`).join('')}
      </div>
      <div class="nutrient-guide">
        <h3>üìä ‡∏Ñ‡πà‡∏≤‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞</h3>
        ${Object.values(hydroNutrients).map(n => `<div class="nutrient-row"><span>${n.stage} (‡∏ß‡∏±‡∏ô ${n.days})</span><span>EC: ${n.ec} | pH: ${n.ph}</span></div>`).join('')}
      </div>
    </div>`;
  }
  
  html += `<div class="btn-row" style="margin-bottom:10px;"><button class="btn btn-danger btn-sm" onclick="deletePlot('${plot.id}')">üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏õ‡∏•‡∏á</button></div>`;
  
  $('plannerContent').innerHTML = html;
}

function renderToday() {
  const plot = getCurrentPlot();
  if (!plot) { $('todayContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p></div>`; return; }
  
  const current = getCurrentPhase(plot), next = getNextPhase(plot);
  const totalDays = plot.veggie.totalDays || plot.veggie.days;
  const dayNum = getDaysDiff(today, plot.startDate) + 1;
  const daysLeft = Math.max(0, totalDays - dayNum + 1);
  const pct = Math.min(100, Math.max(0, Math.round((dayNum / totalDays) * 100)));
  const todayLog = (plot.dailyLogs || {})[todayKey] || {};
  const isHydro = plot.type === 'hydro';
  
  let html = `<div class="plot-card ${isHydro ? 'hydro' : 'organic'}">
    <h2 style="font-size:0.9em;margin-bottom:4px;">üìÖ ${formatDateFull(today)}</h2>
    <p style="font-size:0.8em;opacity:0.9;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayNum} - ${plot.name} ${plot.veggie.icon}</p>
    <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">
      <span style="background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:0.7em;">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${daysLeft} ‡∏ß‡∏±‡∏ô</span>
      <span style="background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:0.7em;">${pct}%</span>
      ${isHydro ? `<span style="background:rgba(255,255,255,0.25);padding:4px 10px;border-radius:12px;font-size:0.7em;">üíß ${hydroSystems[plot.hydroSystem]?.name}</span>` : ''}
    </div>
  </div>`;
  
  if (current) {
    const comp = getPhaseCompletion(plot, current);
    const tasks = plot.completedTasks || {};
    html += `<div class="card phase-card ${isHydro ? 'hydro' : ''}">
      <div class="phase-header">
        <span class="phase-title">${current.name}</span>
        <span class="phase-badge ${isHydro ? 'hydro' : ''}">üéØ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</span>
      </div>
      <p class="phase-desc">${current.desc}</p>
      ${current.hydro ? `<div class="hydro-stats" style="margin-bottom:10px;">
        <div class="hydro-stat"><div class="value">${current.hydro.ec}</div><div class="label">EC ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div></div>
        <div class="hydro-stat"><div class="value">${current.hydro.ph}</div><div class="label">pH ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</div></div>
      </div>` : ''}
      ${current.bio?.length ? `<div class="bio-tags">${current.bio.map(b => `<span class="bio-tag bio-${bioProducts[b].color}">${bioProducts[b].icon} ${bioProducts[b].name}</span>`).join('')}</div>` : ''}
      <ul class="checklist">${current.tasks.map((t, i) => `<li class="${tasks[`${current.id}-${i}`] ? 'done' : ''}" onclick="toggleTask('${plot.id}', '${current.id}', ${i})"><input type="checkbox" ${tasks[`${current.id}-${i}`] ? 'checked' : ''}><span>${t}</span></li>`).join('')}</ul>
      <div class="progress-wrap"><div class="progress-bar ${isHydro ? 'hydro' : ''}" style="width:${comp}%"></div></div>
      <div class="progress-text"><span>‡∏ó‡∏≥‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß</span><span>${comp}%</span></div>
    </div>`;
  }
  
  const quickBtns = isHydro 
    ? [{id:'check_ec',icon:'üìä',label:'‡∏ß‡∏±‡∏î EC'},{id:'check_ph',icon:'üß™',label:'‡∏ß‡∏±‡∏î pH'},{id:'check',icon:'üîç',label:'‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πâ‡∏ô'},{id:'add_nutrient',icon:'üíß',label:'‡πÄ‡∏ï‡∏¥‡∏°‡∏™‡∏≤‡∏£'},{id:'change_water',icon:'üîÑ',label:'‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡πâ‡∏≥'},{id:'photo',icon:'üì∏',label:'‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ'}]
    : [{id:'water_am',icon:'üíß',label:'‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏ä‡πâ‡∏≤'},{id:'water_pm',icon:'üíß',label:'‡∏£‡∏î‡∏ô‡πâ‡∏≥‡πÄ‡∏¢‡πá‡∏ô'},{id:'check',icon:'üîç',label:'‡∏ï‡∏£‡∏ß‡∏à‡∏ï‡πâ‡∏ô'},{id:'em',icon:'ü¶†',label:'‡πÉ‡∏´‡πâ EM'},{id:'tricho',icon:'üçÑ',label:'‡∏â‡∏µ‡∏î‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ'},{id:'photo',icon:'üì∏',label:'‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ'}];
  
  html += `<div class="card ${isHydro ? 'hydro' : ''}"><h2>‚ö° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô</h2><div class="quick-btns">${quickBtns.map(item => `<button class="quick-btn ${isHydro ? 'hydro' : ''} ${todayLog[item.id] ? 'done' : ''}" onclick="logDaily('${plot.id}', '${item.id}')"><span class="icon">${item.icon}</span><span class="label">${item.label}</span>${todayLog[item.id] ? `<span class="time">‚úì ${todayLog[item.id]}</span>` : ''}</button>`).join('')}</div></div>`;
  
  if (next) html += `<div class="card" style="background:#e3f2fd;border-left:4px solid #2196f3;"><h3 style="color:#1565c0;font-size:0.85em;">‚è≠Ô∏è ‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ${next.name}</h3><p style="font-size:0.75em;color:#1565c0;">üìÖ ${formatDate(next.date)} (‡∏≠‡∏µ‡∏Å ${getDaysDiff(new Date(next.date), today)} ‡∏ß‡∏±‡∏ô)</p></div>`;
  
  $('todayContent').innerHTML = html;
}

function renderProgress() {
  const plot = getCurrentPlot();
  if (!plot) { $('progressContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p></div>`; return; }
  
  const totalDays = plot.veggie.totalDays || plot.veggie.days;
  const dayNum = Math.max(1, getDaysDiff(today, plot.startDate) + 1);
  const daysLeft = Math.max(0, totalDays - dayNum + 1);
  const pct = Math.min(100, Math.max(0, Math.round((dayNum / totalDays) * 100)));
  const tasksDone = Object.values(plot.completedTasks || {}).filter(Boolean).length;
  const current = getCurrentPhase(plot);
  const isHydro = plot.type === 'hydro';
  
  let html = `<div class="card ${isHydro ? 'hydro' : ''}"><h2>üìà ${plot.name}</h2>
    <div class="stats-grid">
      <div class="stat-box green"><div class="stat-value">${dayNum}</div><div class="stat-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div></div>
      <div class="stat-box blue"><div class="stat-value">${tasksDone}</div><div class="stat-label">‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à</div></div>
      <div class="stat-box purple"><div class="stat-value">${daysLeft}</div><div class="stat-label">‡∏ß‡∏±‡∏ô‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div></div>
      <div class="stat-box orange"><div class="stat-value">${pct}%</div><div class="stat-label">‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤</div></div>
    </div>
  </div>`;
  
  if (plot.growthLogs?.length >= 2) html += `<div class="card ${isHydro ? 'hydro' : ''}"><h2>üìä ‡∏Å‡∏£‡∏≤‡∏ü‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</h2><div class="chart-container"><canvas id="growthChart"></canvas></div></div>`;
  
  html += `<div class="card ${isHydro ? 'hydro' : ''}"><h2>üìä ‡πÑ‡∏ó‡∏°‡πå‡πÑ‡∏•‡∏ô‡πå</h2>${plot.phases.map((phase, idx) => {
    const isPast = new Date(phase.date) < today, isCurrent = current?.id === phase.id, comp = getPhaseCompletion(plot, phase);
    return `<div class="timeline-item"><div class="timeline-dot ${isCurrent ? 'current' : isPast ? 'done' : 'future'}">${isPast && comp === 100 ? '‚úì' : idx + 1}</div><div class="timeline-content ${isCurrent ? 'current' : isPast ? 'done' : 'future'}"><span class="timeline-title">${phase.name}</span>${(isPast || isCurrent) ? `<span class="timeline-percent ${comp === 100 ? 'complete' : 'partial'}">${comp}%</span>` : ''}<div class="timeline-date">${formatDate(phase.date)}${phase.hydro ? ` | EC: ${phase.hydro.ec}` : ''}</div>${isCurrent ? '<div style="font-size:0.7em;color:#f9a825;margin-top:4px;">üëà ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>' : ''}</div></div>`;
  }).join('')}</div>`;
  
  $('progressContent').innerHTML = html;
  if (plot.growthLogs?.length >= 2) setTimeout(() => renderChart(plot), 100);
}

function renderChart(plot) {
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
  const ctx = document.getElementById('growthChart')?.getContext('2d');
  if (!ctx) return;
  
  const logs = [...plot.growthLogs].sort((a, b) => a.day - b.day);
  const datasets = [
    { label: '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡∏ã‡∏°.)', data: logs.map(l => l.height), borderColor: '#4caf50', backgroundColor: 'rgba(76,175,80,0.1)', tension: 0.3, fill: true, yAxisID: 'y' }
  ];
  
  if (plot.type === 'hydro' && logs.some(l => l.ec)) {
    datasets.push({ label: 'EC', data: logs.map(l => l.ec), borderColor: '#ff9800', backgroundColor: 'rgba(255,152,0,0.1)', tension: 0.3, fill: false, yAxisID: 'y1' });
  } else if (logs.some(l => l.leaves)) {
    datasets.push({ label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö', data: logs.map(l => l.leaves), borderColor: '#2196f3', backgroundColor: 'rgba(33,150,243,0.1)', tension: 0.3, fill: true, yAxisID: 'y1' });
  }
  
  chartInstance = new Chart(ctx, {
    type: 'line',
    data: { labels: logs.map(l => `‡∏ß‡∏±‡∏ô ${l.day}`), datasets },
    options: { responsive: true, maintainAspectRatio: false, scales: { y: { position: 'left', title: { display: true, text: '‡∏ã‡∏°.' } }, y1: { position: 'right', grid: { drawOnChartArea: false } } } }
  });
}

function renderRecord() {
  const plot = getCurrentPlot();
  if (!plot) { $('recordContent').innerHTML = `<div class="empty-state"><div class="icon">üå±</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÅ‡∏õ‡∏•‡∏á</p></div>`; return; }
  
  const dayNum = getDaysDiff(today, plot.startDate) + 1;
  const isHydro = plot.type === 'hydro';
  
  let html = `<div class="card ${isHydro ? 'hydro' : ''}"><h2>üìè ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å - ${plot.name}</h2>
    <p style="font-size:0.75em;color:#888;margin-bottom:10px;">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${dayNum}</p>
    <div class="form-row">
      <div class="form-group"><label>üìè ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á (‡∏ã‡∏°.)</label><input type="number" id="newHeight" placeholder="‡πÄ‡∏ä‡πà‡∏ô 5" min="0" class="${isHydro ? 'hydro-input' : ''}"></div>
      <div class="form-group"><label>üçÉ ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö</label><input type="number" id="newLeaves" placeholder="‡πÄ‡∏ä‡πà‡∏ô 4" min="0" class="${isHydro ? 'hydro-input' : ''}"></div>
    </div>
    ${isHydro ? `<div class="form-row">
      <div class="form-group"><label>üìä EC</label><input type="number" id="newEC" placeholder="‡πÄ‡∏ä‡πà‡∏ô 1.2" step="0.1" class="hydro-input"></div>
      <div class="form-group"><label>üß™ pH</label><input type="number" id="newPH" placeholder="‡πÄ‡∏ä‡πà‡∏ô 6.0" step="0.1" class="hydro-input"></div>
    </div>` : ''}
    <div class="form-group"><label>‚ö†Ô∏è ‡∏õ‡∏±‡∏ç‡∏´‡∏≤</label><input type="text" id="problemLog" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÉ‡∏ö‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á" class="${isHydro ? 'hydro-input' : ''}"></div>
    <button class="btn ${isHydro ? 'btn-blue' : ''}" onclick="addGrowthLog('${plot.id}')">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>`;
  
  const logs = plot.growthLogs || [];
  html += `<div class="card ${isHydro ? 'hydro' : ''}"><h2>üìä ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (${logs.length})</h2>${logs.length === 0 ? '<p style="text-align:center;color:#999;padding:20px;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ</p>' : logs.slice().reverse().map(log => `<div class="growth-item"><button class="delete-btn" onclick="deleteGrowthLog('${plot.id}', '${log.id}')" title="‡∏•‡∏ö">√ó</button><div class="growth-header"><span class="growth-day">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ${log.day}</span><span class="growth-date">${formatDate(log.date)}</span></div><div class="growth-tags">${log.height ? `<span class="growth-tag height">üìè ${log.height} ‡∏ã‡∏°.</span>` : ''}${log.leaves ? `<span class="growth-tag leaves">üçÉ ${log.leaves} ‡πÉ‡∏ö</span>` : ''}${log.ec ? `<span class="growth-tag ec">EC ${log.ec}</span>` : ''}${log.ph ? `<span class="growth-tag ph">pH ${log.ph}</span>` : ''}${log.problem ? `<span class="growth-tag problem">‚ö†Ô∏è ${log.problem}</span>` : ''}</div></div>`).join('')}</div>`;
  
  $('recordContent').innerHTML = html;
}

function renderGuide() {
  let html = `<div class="tabs">
    <button class="tab-btn ${guideTab === 'organic' ? 'active' : ''}" onclick="guideTab='organic';renderGuide()">üå± ‡∏≠‡∏¥‡∏ô‡∏ó‡∏£‡∏µ‡∏¢‡πå</button>
    <button class="tab-btn hydro ${guideTab === 'hydro' ? 'active' : ''}" onclick="guideTab='hydro';renderGuide()">üíß ‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÇ‡∏õ‡∏ô‡∏¥‡∏Å‡∏™‡πå</button>
  </div>`;
  
  if (guideTab === 'organic') {
    html += `<div class="card"><h2>üìñ ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏™‡∏≤‡∏£‡∏ä‡∏µ‡∏ß‡∏†‡∏±‡∏ì‡∏ë‡πå</h2>${Object.entries(bioProducts).map(([key, bio]) => `<div class="bio-accordion bio-${bio.color}" onclick="this.classList.toggle('open')" style="border-color:currentColor;"><div class="bio-accordion-header"><div class="info"><span class="icon">${bio.icon}</span><div><div class="name">${bio.name}</div><div class="fullname">${bio.fullName}</div></div></div><span class="arrow">‚ñº</span></div><div class="bio-accordion-body" onclick="event.stopPropagation()"><div class="bio-info-box"><b>üìè ‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏ß‡∏ô:</b> ${bio.ratio}</div><div class="bio-info-box"><b>‚è∞ ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏´‡∏£‡πà:</b> ${bio.when}</div><div class="bio-info-box"><b>‚úÖ ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå:</b><ul>${bio.benefits.map(b => `<li>${b}</li>`).join('')}</ul></div></div></div>`).join('')}</div>`;
    
    html += `<div class="warning-box"><h3>‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏£‡∏£‡∏∞‡∏ß‡∏±‡∏á</h3><ul>
      <li><span>‚ùå</span> ‡πÑ‡∏ï‡∏£‡πÇ‡∏Ñ + ‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢ ‡πÑ‡∏°‡πà‡∏Ñ‡∏ß‡∏£‡∏ú‡∏™‡∏°‡∏Å‡∏±‡∏ô</li>
      <li><span>‚úÖ</span> ‡∏ö‡∏¥‡∏ß‡πÄ‡∏ß‡∏≠‡πÄ‡∏£‡∏µ‡∏¢ + ‡πÄ‡∏°‡∏ï‡∏≤‡πÑ‡∏£‡πÄ‡∏ã‡∏µ‡∏¢‡∏° ‡πÉ‡∏ä‡πâ‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ</li>
      <li><span>üåÖ</span> ‡∏â‡∏µ‡∏î‡∏û‡πà‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ä‡πâ‡∏≤‡∏ï‡∏£‡∏π‡πà</li>
      <li><span>‚è∏Ô∏è</span> ‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏µ‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏Å‡πá‡∏ö 3-5 ‡∏ß‡∏±‡∏ô</li>
    </ul></div>`;
  } else {
    html += `<div class="card hydro"><h2>üíß ‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏Æ‡πÇ‡∏î‡∏£‡πÇ‡∏õ‡∏ô‡∏¥‡∏Å‡∏™‡πå</h2>${Object.entries(hydroSystems).map(([key, sys]) => `<div class="bio-accordion" style="border-color:#90caf9;" onclick="this.classList.toggle('open')"><div class="bio-accordion-header"><div class="info"><span class="icon">${sys.icon}</span><div><div class="name">${sys.name}</div><div class="fullname">${sys.fullName}</div></div></div><span class="arrow">‚ñº</span></div><div class="bio-accordion-body" onclick="event.stopPropagation()"><div class="bio-info-box"><b>üìù ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢:</b> ${sys.desc}</div><div class="bio-info-box"><b>‚úÖ ‡∏Ç‡πâ‡∏≠‡∏î‡∏µ:</b><ul>${sys.pros.map(p => `<li>${p}</li>`).join('')}</ul></div><div class="bio-info-box"><b>‚ö†Ô∏è ‡∏Ç‡πâ‡∏≠‡πÄ‡∏™‡∏µ‡∏¢:</b><ul>${sys.cons.map(c => `<li>${c}</li>`).join('')}</ul></div></div></div>`).join('')}</div>`;
    
    html += `<div class="card hydro"><h2>üìä ‡∏Ñ‡πà‡∏≤ EC/pH ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</h2>
      <div class="nutrient-guide" style="background:#fff;">
        ${Object.values(hydroNutrients).map(n => `<div class="nutrient-row"><span><b>${n.stage}</b> (‡∏ß‡∏±‡∏ô ${n.days})</span><span>EC: ${n.ec} | pH: ${n.ph}</span></div>`).join('')}
      </div>
    </div>`;
    
    html += `<div class="card hydro"><h2>üß™ ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ú‡∏™‡∏°‡∏™‡∏≤‡∏£‡∏•‡∏∞‡∏•‡∏≤‡∏¢ A-B</h2>
      <div class="bio-info-box"><b>1. ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡πâ‡∏≥:</b> ‡∏ô‡πâ‡∏≥‡∏õ‡∏£‡∏∞‡∏õ‡∏≤‡∏û‡∏±‡∏Å 24 ‡∏ä‡∏°. ‡∏´‡∏£‡∏∑‡∏≠ ‡∏ô‡πâ‡∏≥ RO</div>
      <div class="bio-info-box"><b>2. ‡∏ú‡∏™‡∏°‡∏™‡∏≤‡∏£ A ‡∏Å‡πà‡∏≠‡∏ô:</b> ‡∏Ñ‡∏ô‡πÉ‡∏´‡πâ‡∏•‡∏∞‡∏•‡∏≤‡∏¢‡∏´‡∏°‡∏î</div>
      <div class="bio-info-box"><b>3. ‡∏ú‡∏™‡∏°‡∏™‡∏≤‡∏£ B:</b> ‡∏´‡πâ‡∏≤‡∏°‡∏ú‡∏™‡∏° A+B ‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á!</div>
      <div class="bio-info-box"><b>4. ‡∏ï‡∏£‡∏ß‡∏à EC:</b> ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏¥‡∏ö‡πÇ‡∏ï</div>
      <div class="bio-info-box"><b>5. ‡∏õ‡∏£‡∏±‡∏ö pH:</b> ‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏î/‡∏î‡πà‡∏≤‡∏á‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ 5.5-6.5</div>
    </div>`;
    
    html += `<div class="tip-box"><h3>üí° ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡πÑ‡∏Æ‡πÇ‡∏î‡∏£</h3><ul>
      <li><span>üå°Ô∏è</span> ‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏ô‡πâ‡∏≥ 18-25¬∞C ‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î</li>
      <li><span>üîÑ</span> ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ô‡πâ‡∏≥‡∏ó‡∏∏‡∏Å 7-14 ‡∏ß‡∏±‡∏ô</li>
      <li><span>üí®</span> ‡∏£‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏ã‡∏¥‡πÄ‡∏à‡∏ô (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô Kratky)</li>
      <li><span>üßπ</span> ‡∏•‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏∏‡∏Å‡∏£‡∏≠‡∏ö‡∏õ‡∏•‡∏π‡∏Å</li>
      <li><span>üìä</span> ‡∏ß‡∏±‡∏î EC/pH ‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô ‡∏´‡∏£‡∏∑‡∏≠‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡∏±‡∏ô</li>
    </ul></div>`;
  }
  
  $('guideContent').innerHTML = html;
}

// ==================== Init ====================
document.addEventListener('DOMContentLoaded', () => {
  try {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    updateSyncBadge('syncing', 'üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
    loadData();
  } catch (e) {
    updateSyncBadge('error', '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');
    console.error(e);
  }
  renderGuide();
});

$('modal')?.addEventListener('click', e => { if (e.target.id === 'modal') closeModal(); });
</script>
</body>
</html>
